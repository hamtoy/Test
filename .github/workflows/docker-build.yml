name: Docker Build

on:
  push:
    tags:
      - "v*" # Only on version tags
  release:
    types: [published]
  workflow_dispatch: # Manual trigger

permissions:
  contents: read
  security-events: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: hamtoy/test:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Check image size
        run: |
          size=$(docker images hamtoy/test:test --format "{{.Size}}")
          echo "Image size: $size"
          echo "IMAGE_SIZE=$size" >> $GITHUB_ENV

      - name: Security scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: hamtoy/test:test
          format: "sarif"
          output: "trivy-results.sarif"
          exit-code: "0"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: "trivy-results.sarif"

      - name: Test container startup
        run: |
          # Start container with test environment
          docker run -d --name test-container \
            -e GEMINI_API_KEY=AIzaTestKeyForBuildValidation12345678 \
            -e ENVIRONMENT=test \
            hamtoy/test:test \
            python -c "print('Container started successfully')"

          # Wait for startup
          sleep 5

          # Check logs
          echo "Container logs:"
          docker logs test-container

          # Verify container is running
          docker ps -a

          # Cleanup
          docker stop test-container || true
          docker rm test-container || true

      - name: Verify Docker Compose syntax
        run: |
          # Create empty .env files for compose config validation
          touch .env
          touch .env.production
          docker compose -f docker-compose.yml config
          docker compose -f docker-compose.worker.yml config
