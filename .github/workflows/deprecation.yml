name: Deprecation

on:
  schedule:
    - cron: "0 0 * * 1" # Every Monday at midnight UTC
  workflow_dispatch: # Manual trigger

permissions:
  contents: read
  issues: write

jobs:
  check-normal:
    name: Check (Normal Mode)
    runs-on: ubuntu-latest
    env:
      DEPRECATION_LEVEL: normal
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.4.x"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run deprecation check
        run: uv run python scripts/migrate_imports.py --check --path .

      - name: Run tests (warnings allowed)
        run: uv run python -m pytest tests/ -v -W default::DeprecationWarning
        continue-on-error: true

  check-strict:
    name: Check (Strict Mode)
    runs-on: ubuntu-latest
    env:
      DEPRECATION_LEVEL: strict
      PYTHONWARNINGS: "error::DeprecationWarning"
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.4.x"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run strict deprecation check
        run: |
          echo "Running in strict mode - deprecation warnings will cause failures"
          uv run python scripts/migrate_imports.py --check --path src/

      - name: Verify no deprecated imports in src/
        run: |
          uv run python scripts/deprecation_stats.py --path src/ --exclude __pycache__ --json /tmp/stats.json || true
          if [ -f /tmp/stats.json ]; then
            cat /tmp/stats.json
          else
            echo "No deprecation stats generated (no deprecated imports found)"
          fi

  generate-report:
    name: Generate Weekly Report
    runs-on: ubuntu-latest
    needs: [check-normal]
    if: always()
    outputs:
      total_calls: ${{ steps.analyze.outputs.total_calls }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.4.x"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Analyze deprecation usage
        id: analyze
        run: |
          uv run python scripts/deprecation_stats.py \
            --path . \
            --exclude .venv \
            --exclude __pycache__ \
            --exclude .git \
            --html deprecation_report.html \
            --json deprecation_stats.json || true

          if [ -f deprecation_stats.json ]; then
            TOTAL_CALLS=$(python -c "import json; print(json.load(open('deprecation_stats.json'))['stats']['total_calls'])")
          else
            echo '{"timestamp": "'$(date -Iseconds)'", "stats": {"total_calls": 0, "unique_callers": 0, "by_module": {}, "files_with_deprecations": []}}' > deprecation_stats.json
            TOTAL_CALLS=0
          fi

          # Create empty HTML report if not generated
          if [ ! -f deprecation_report.html ]; then
            echo '<!DOCTYPE html><html><head><title>Deprecation Report</title></head><body><h1>No Deprecations Found</h1><p>No deprecated imports detected.</p></body></html>' > deprecation_report.html
          fi

          echo "total_calls=${TOTAL_CALLS}" >> $GITHUB_OUTPUT
          echo "üìä Total deprecated calls: ${TOTAL_CALLS}"

      - name: Upload HTML Report
        uses: actions/upload-artifact@v5
        with:
          name: deprecation-report
          path: deprecation_report.html
          retention-days: 90

      - name: Upload JSON Stats
        uses: actions/upload-artifact@v5
        with:
          name: deprecation-stats-json
          path: deprecation_stats.json
          retention-days: 90

  create-issue:
    name: Create Issue (High Usage)
    runs-on: ubuntu-latest
    needs: generate-report
    if: needs.generate-report.outputs.total_calls > 100
    steps:
      - name: Create Issue
        uses: actions/github-script@v8
        with:
          script: |
            const totalCalls = ${{ needs.generate-report.outputs.total_calls }};
            const date = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ö†Ô∏è High Deprecated Import Usage Detected (${date})`,
              body: `## Deprecation Report Summary

            **Date**: ${date}
            **Total Deprecated Calls**: ${totalCalls}

            ### Action Required

            The number of deprecated import usages exceeds the threshold of 100.
            Please review the weekly report artifact and prioritize migration.

            ### Migration Steps

            1. Download the HTML report from the workflow artifacts
            2. Review the affected files
            3. Run the migration tool:
               \`\`\`bash
               python scripts/migrate_imports.py --check --path src/
               python scripts/migrate_imports.py --fix --path src/
               \`\`\`

            ---
            *This issue was automatically created by the Deprecation workflow.*`,
              labels: ['deprecation', 'maintenance', 'automated']
            });
