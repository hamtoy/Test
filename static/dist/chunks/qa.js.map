{"version":3,"file":"qa.js","sources":["../../qa.ts"],"sourcesContent":["import { apiCall, showToast, showProgressWithEstimate, withRetry } from \"./utils.js\";\r\nimport { loadOCR, saveOCR } from \"./ocr.js\";\r\nimport { validateRequest, ValidationError } from \"./validation.js\";\r\n\r\ndeclare global {\r\n    interface Window {\r\n        DOMPurify: {\r\n            sanitize: (text: string) => string;\r\n        };\r\n    }\r\n}\r\n\r\ninterface QAPair {\r\n    type: string;\r\n    query: string;\r\n    answer: string;\r\n}\r\n\r\ninterface QAData {\r\n    success?: boolean;\r\n    data?: {\r\n        pairs?: QAPair[];\r\n        pair?: QAPair;\r\n    };\r\n    pairs?: QAPair[]; // flatten access\r\n    pair?: QAPair;\r\n}\r\n\r\nlet activeController: AbortController | null = null;\r\n\r\nfunction getModeLabels(mode: string): { title: string; eta: string } {\r\n    if (mode === \"batch\") {\r\n        return { title: \"‚ö° 4Í∞ú ÌÉÄÏûÖ ÎèôÏãú ÏÉùÏÑ± Ï§ë...\", eta: \"30Ï¥à~2Î∂Ñ\" };\r\n    }\r\n    if (mode === \"batch_three\") {\r\n        return { title: \"‚ö° 3Í∞ú ÌÉÄÏûÖ ÎèôÏãú ÏÉùÏÑ± Ï§ë...\", eta: \"20Ï¥à~90Ï¥à\" };\r\n    }\r\n    return { title: \"üöÄ ÎãµÎ≥Ä ÏÉùÏÑ± Ï§ë...\", eta: \"15Ï¥à~1Î∂Ñ\" };\r\n}\r\n\r\nfunction renderProgress(mode: string): string {\r\n    const { title, eta } = getModeLabels(mode);\r\n    return `\r\n        <div class=\"progress-container\" style=\"text-align: center; padding: 40px 20px; background: var(--bg-secondary, #f5f5f5); border-radius: 8px;\">\r\n            <h3 style=\"margin-bottom: 20px; color: var(--text-primary, #333);\">${title}</h3>\r\n            <div style=\"margin: 25px auto; width: 320px; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);\">\r\n                <div class=\"progress-fill\" style=\"width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary, #21808d) 0%, var(--primary-dark, #1a6673) 100%); transition: width 0.5s ease;\"></div>\r\n            </div>\r\n            <p style=\"color: var(--text-secondary, #666); font-size: 0.95em; margin-top: 20px; font-weight: 500;\">ÏòàÏÉÅ ÏÜåÏöî ÏãúÍ∞Ñ: <strong>${eta}</strong></p>\r\n            <p style=\"color: var(--text-secondary, #666); font-size: 0.85em; margin-top: 8px;\">Î≥ëÎ†¨ Ï≤òÎ¶¨Î°ú Îπ†Î•¥Í≤å ÏôÑÎ£åÎê©ÎãàÎã§ ‚ú®</p>\r\n        </div>\r\n    `;\r\n}\r\n\r\nfunction escapeHtml(text: string): string {\r\n    const div = document.createElement(\"div\");\r\n    div.textContent = text || \"\";\r\n    return div.innerHTML;\r\n}\r\n\r\nfunction formatAnswer(text: string): string {\r\n    // ÎßàÌÅ¨Îã§Ïö¥ Î†åÎçîÎßÅ ÏóÜÏù¥ raw ÌÖçÏä§Ìä∏Î°ú ÌëúÏãú (ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ÏôÄ ÎèôÏùº)\r\n    const escaped = escapeHtml(text);\r\n    const formatted = escaped\r\n        .replaceAll(\"\\n\\n\", \"<br><br>\")  // Î¨∏Îã® Íµ¨Î∂Ñ\r\n        .replaceAll(\"\\n\", \"<br>\")         // ÏùºÎ∞ò Ï§ÑÎ∞îÍøà\r\n        .replaceAll(\" - \", \"<br><br>- \"); // Î∂àÎ¶ø Ìè¨Ïù∏Ìä∏ ÏïûÏóê Ï§ÑÎ∞îÍøà Ï∂îÍ∞Ä\r\n    return window.DOMPurify ? window.DOMPurify.sanitize(formatted) : formatted;\r\n}\r\n\r\nfunction getTypeBadge(type: string): string {\r\n    const badges: Record<string, string> = {\r\n        explanation: \"üåç Ï†ÑÎ∞ò ÏÑ§Î™Ö\",\r\n        global_explanation: \"üåç Ï†ÑÎ∞ò ÏÑ§Î™Ö\",\r\n        reasoning: \"üß† Ï∂îÎ°†\",\r\n        target_short: \"üéØ ÌÉÄÍ≤ü Îã®Îãµ\",\r\n        target_long: \"üìù ÌÉÄÍ≤ü Ïû•Îãµ\",\r\n    };\r\n    return badges[type] || type;\r\n}\r\n\r\nfunction copyToWorkspace(query: string, answer: string): void {\r\n    sessionStorage.setItem(\"workspace_query\", query);\r\n    sessionStorage.setItem(\"workspace_answer\", answer);\r\n    window.location.href = \"/workspace\";\r\n}\r\n\r\nfunction isQAPair(value: unknown): value is QAPair {\r\n    if (!value || typeof value !== \"object\") return false;\r\n    const candidate = value as Record<string, unknown>;\r\n    return (\r\n        typeof candidate.type === \"string\" &&\r\n        typeof candidate.query === \"string\" &&\r\n        typeof candidate.answer === \"string\"\r\n    );\r\n}\r\n\r\nfunction extractPairs(raw: unknown): QAPair[] {\r\n    if (!raw || typeof raw !== \"object\") return [];\r\n\r\n    const payload = raw as QAData;\r\n    const candidates: unknown[] = [];\r\n\r\n    if (payload.pairs) candidates.push(...payload.pairs);\r\n    if (payload.pair) candidates.push(payload.pair);\r\n    if (payload.data?.pairs) candidates.push(...payload.data.pairs);\r\n    if (payload.data?.pair) candidates.push(payload.data.pair);\r\n\r\n    return candidates.filter(isQAPair);\r\n}\r\n\r\nfunction displayResults(raw: unknown): void {\r\n    let pairs = extractPairs(raw);\r\n    const resultsDiv = document.getElementById(\"results\");\r\n    if (!resultsDiv) return;\r\n    resultsDiv.setAttribute(\"role\", \"status\");\r\n    resultsDiv.setAttribute(\"aria-live\", \"polite\");\r\n    resultsDiv.innerHTML = \"\";\r\n\r\n    const selectedMode = (document.querySelector(\"input[name=\\\"mode\\\"]:checked\") as HTMLInputElement)?.value;\r\n    if (selectedMode === \"batch_three\") {\r\n        const allowed = new Set([\"global_explanation\", \"reasoning\", \"target_long\"]);\r\n        pairs = pairs.filter((p) => allowed.has(p.type));\r\n    }\r\n    if (!pairs.length) {\r\n        const emptyCard = document.createElement(\"div\");\r\n        emptyCard.className = \"qa-card\";\r\n        const emptyText = document.createElement(\"p\");\r\n        emptyText.className = \"qa-empty-message\";\r\n        emptyText.textContent = \"Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.\";\r\n        emptyCard.appendChild(emptyText);\r\n        resultsDiv.appendChild(emptyCard);\r\n        return;\r\n    }\r\n\r\n    pairs.forEach((item, index) => {\r\n        const card = document.createElement(\"div\");\r\n        card.className = \"qa-card\";\r\n        card.style.animation = `slideIn 0.3s ease-out ${index * 0.05}s both`;\r\n\r\n        // Header with type badge\r\n        const header = document.createElement(\"div\");\r\n        header.className = \"qa-header\";\r\n        const badge = document.createElement(\"span\");\r\n        badge.className = \"qa-type-badge\";\r\n        badge.textContent = getTypeBadge(item.type);\r\n        header.appendChild(badge);\r\n        card.appendChild(header);\r\n\r\n        // Query section\r\n        const querySection = document.createElement(\"div\");\r\n        querySection.className = \"qa-section\";\r\n        const queryLabel = document.createElement(\"strong\");\r\n        queryLabel.textContent = \"üí¨ ÏßàÏùò\";\r\n        const queryContent = document.createElement(\"div\");\r\n        queryContent.className = \"qa-content\";\r\n        queryContent.textContent = item.query;\r\n        querySection.appendChild(queryLabel);\r\n        querySection.appendChild(queryContent);\r\n        card.appendChild(querySection);\r\n\r\n        // Answer section\r\n        const answerSection = document.createElement(\"div\");\r\n        answerSection.className = \"qa-section\";\r\n        const answerLabel = document.createElement(\"strong\");\r\n        answerLabel.textContent = \"‚ú® ÎãµÎ≥Ä\";\r\n        const answerContent = document.createElement(\"div\");\r\n        answerContent.className = \"qa-content\";\r\n        // Use innerHTML with sanitized content for answer formatting\r\n        answerContent.innerHTML = formatAnswer(item.answer);\r\n        answerSection.appendChild(answerLabel);\r\n        answerSection.appendChild(answerContent);\r\n        card.appendChild(answerSection);\r\n\r\n        // Button row\r\n        const btnRow = document.createElement(\"div\");\r\n        btnRow.className = \"btn-row qa-btn-row\";\r\n        const copyBtn = document.createElement(\"button\");\r\n        copyBtn.className = \"btn-small qa-copy-btn\";\r\n        copyBtn.textContent = \"üìù ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Î°ú Î≥µÏÇ¨\";\r\n        copyBtn.addEventListener(\"click\", () => {\r\n            copyToWorkspace(item.query || \"\", item.answer || \"\");\r\n        });\r\n        btnRow.appendChild(copyBtn);\r\n        card.appendChild(btnRow);\r\n\r\n        resultsDiv.appendChild(card);\r\n    });\r\n}\r\n\r\ntype GenerateMode = \"single\" | \"batch\" | \"batch_three\";\r\n\r\ninterface GeneratePayload {\r\n    mode: \"single\" | \"batch\";\r\n    ocr_text: string;\r\n    qtype?: string;\r\n    batch_types?: string[];\r\n}\r\n\r\nasync function generateQA(mode: GenerateMode, qtype: string | null): Promise<void> {\r\n    const resultsDiv = document.getElementById(\"results\");\r\n    if (!resultsDiv) return;\r\n    const ocrInput = document.getElementById(\"ocr-input\") as HTMLTextAreaElement;\r\n    const ocrText = ocrInput.value;\r\n\r\n    if (!ocrText.trim()) {\r\n        showToast(\"OCR ÌÖçÏä§Ìä∏Î•º Î®ºÏ†Ä ÏûÖÎ†•ÌïòÏÑ∏Ïöî.\", \"error\");\r\n        return;\r\n    }\r\n\r\n    resultsDiv.innerHTML = renderProgress(mode);\r\n    const stopProgress = showProgressWithEstimate(mode === \"batch\" || mode === \"batch_three\" ? \"batch\" : \"single\");\r\n    const progressBar = document.querySelector(\".progress-fill\") as HTMLElement;\r\n\r\n    try {\r\n        const payload: GeneratePayload =\r\n            mode === \"single\"\r\n                ? {\r\n                    mode: \"single\",\r\n                    ocr_text: ocrText,\r\n                    qtype: qtype || \"global_explanation\",\r\n                }\r\n                : {\r\n                    mode: \"batch\",\r\n                    ocr_text: ocrText,\r\n                };\r\n\r\n        if (mode === \"batch_three\") {\r\n            payload.batch_types = [\r\n                \"global_explanation\",\r\n                \"reasoning\",\r\n                \"target_long\",\r\n            ];\r\n        }\r\n\r\n        // Validate request payload before sending\r\n        try {\r\n            validateRequest(payload, \"/api/qa/generate\");\r\n        } catch (validationError) {\r\n            if (validationError instanceof ValidationError) {\r\n                showToast(`ÏöîÏ≤≠ Í≤ÄÏ¶ù Ïã§Ìå®: ${validationError.message}`, \"error\");\r\n                stopProgress();\r\n                resultsDiv.innerHTML = `\r\n                    <div style=\"text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;\">\r\n                        <h3 style=\"color: #f44336; margin-bottom: 10px;\">‚ö†Ô∏è ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ Ïò§Î•ò</h3>\r\n                        <p style=\"color: #666; margin: 0; white-space: pre-line;\">${validationError.message}</p>\r\n                        <p style=\"color: #999; margin-top: 15px; font-size: 0.9em;\">üí° ÌïÑÎìúÎ™ÖÍ≥º Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>\r\n                    </div>\r\n                `;\r\n                return;\r\n            }\r\n            throw validationError;\r\n        }\r\n\r\n        if (activeController) {\r\n            activeController.abort();\r\n        }\r\n        activeController = new AbortController();\r\n        const result = await withRetry(\r\n            () => apiCall<QAData>(\"/api/qa/generate\", \"POST\", payload, activeController!.signal),\r\n            2,\r\n            800,\r\n        );\r\n        activeController = null;\r\n        stopProgress();\r\n        if (progressBar) progressBar.style.width = \"100%\";\r\n        await new Promise((resolve) => setTimeout(resolve, 300));\r\n        displayResults(result);\r\n    } catch (error: unknown) {\r\n        activeController = null;\r\n        stopProgress();\r\n        const message =\r\n            error instanceof Error ? error.message : \"Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\";\r\n        resultsDiv.innerHTML = `\r\n            <div style=\"text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;\">\r\n                <h3 style=\"color: #f44336; margin-bottom: 10px;\">‚ùå ÏÉùÏÑ± Ïã§Ìå®</h3>\r\n                <p style=\"color: #666; margin: 0;\">${message}</p>\r\n            </div>\r\n        `;\r\n    }\r\n}\r\n\r\n// Streaming helpers\r\nfunction createSkeletonCard(type: string): HTMLElement {\r\n    const card = document.createElement(\"div\");\r\n    card.className = \"qa-card\";\r\n    card.id = `qa-card-${type}`;\r\n    card.setAttribute(\"aria-busy\", \"true\");\r\n    const badge = document.createElement(\"div\");\r\n    badge.className = \"qa-type-badge\";\r\n    badge.textContent = getTypeBadge(type);\r\n    card.appendChild(badge);\r\n    const skeletonQuery = document.createElement(\"div\");\r\n    skeletonQuery.className = \"skeleton skeleton-text\";\r\n    skeletonQuery.style.cssText = \"height: 1.5em; width: 80%; margin: 16px 0\";\r\n    card.appendChild(skeletonQuery);\r\n    const skeletonAnswer = document.createElement(\"div\");\r\n    skeletonAnswer.className = \"skeleton skeleton-block\";\r\n    skeletonAnswer.style.cssText = \"height: 100px; margin: 16px 0\";\r\n    card.appendChild(skeletonAnswer);\r\n    return card;\r\n}\r\n\r\nfunction updateCardWithData(type: string, data: QAPair): void {\r\n    const card = document.getElementById(`qa-card-${type}`);\r\n    if (!card) return;\r\n    card.removeAttribute(\"aria-busy\");\r\n    card.innerHTML = \"\";\r\n    const badge = document.createElement(\"div\");\r\n    badge.className = \"qa-type-badge\";\r\n    badge.textContent = getTypeBadge(type);\r\n    card.appendChild(badge);\r\n    const querySection = document.createElement(\"div\");\r\n    querySection.className = \"qa-section\";\r\n    const queryLabel = document.createElement(\"strong\");\r\n    queryLabel.textContent = \"üí¨ ÏßàÏùò\";\r\n    const queryContent = document.createElement(\"div\");\r\n    queryContent.className = \"qa-content\";\r\n    queryContent.textContent = data.query;\r\n    querySection.appendChild(queryLabel);\r\n    querySection.appendChild(queryContent);\r\n    card.appendChild(querySection);\r\n    const answerSection = document.createElement(\"div\");\r\n    answerSection.className = \"qa-section\";\r\n    const answerLabel = document.createElement(\"strong\");\r\n    answerLabel.textContent = \"‚ú® ÎãµÎ≥Ä\";\r\n    const answerContent = document.createElement(\"div\");\r\n    answerContent.className = \"qa-content\";\r\n    answerContent.innerHTML = formatAnswer(data.answer);\r\n    answerSection.appendChild(answerLabel);\r\n    answerSection.appendChild(answerContent);\r\n    card.appendChild(answerSection);\r\n    const btnRow = document.createElement(\"div\");\r\n    btnRow.className = \"btn-row qa-btn-row\";\r\n    const copyBtn = document.createElement(\"button\");\r\n    copyBtn.className = \"btn-small qa-copy-btn\";\r\n    copyBtn.textContent = \"üìù ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Î°ú Î≥µÏÇ¨\";\r\n    copyBtn.addEventListener(\"click\", () => copyToWorkspace(data.query, data.answer));\r\n    btnRow.appendChild(copyBtn);\r\n    card.appendChild(btnRow);\r\n}\r\n\r\nfunction showErrorInCard(type: string, error: string): void {\r\n    const card = document.getElementById(`qa-card-${type}`);\r\n    if (!card) return;\r\n    card.removeAttribute(\"aria-busy\");\r\n    card.innerHTML = \"\";\r\n    card.className = \"qa-card error-state\";\r\n    card.setAttribute(\"role\", \"alert\");\r\n    const icon = document.createElement(\"div\");\r\n    icon.className = \"error-state__icon\";\r\n    icon.textContent = \"‚ö†Ô∏è\";\r\n    card.appendChild(icon);\r\n    const heading = document.createElement(\"h3\");\r\n    heading.style.cssText = \"margin: 0 0 8px 0; color: var(--accent-danger);\";\r\n    heading.textContent = `${getTypeBadge(type)} ÏÉùÏÑ± Ïã§Ìå®`;\r\n    card.appendChild(heading);\r\n    const text = document.createElement(\"p\");\r\n    text.className = \"error-state__text\";\r\n    text.textContent = error;\r\n    card.appendChild(text);\r\n}\r\n\r\nasync function generateQAStreaming(mode: \"batch\" | \"batch_three\"): Promise<void> {\r\n    const resultsDiv = document.getElementById(\"results\");\r\n    if (!resultsDiv) return;\r\n    const ocrInput = document.getElementById(\"ocr-input\") as HTMLTextAreaElement;\r\n    const ocrText = ocrInput.value;\r\n    if (!ocrText.trim()) {\r\n        showToast(\"OCR ÌÖçÏä§Ìä∏Î•º Î®ºÏ†Ä ÏûÖÎ†•ÌïòÏÑ∏Ïöî.\", \"error\");\r\n        return;\r\n    }\r\n    resultsDiv.innerHTML = \"\";\r\n    try {\r\n        const response = await fetch(\"/api/qa/generate/batch/stream\", {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({ mode, ocr_text: ocrText }),\r\n            signal: activeController?.signal\r\n        });\r\n        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n        if (!response.body) throw new Error(\"No response body\");\r\n        const reader = response.body.getReader();\r\n        const decoder = new TextDecoder();\r\n        let buffer = \"\";\r\n        while (true) {\r\n            const { done, value } = await reader.read();\r\n            if (done) break;\r\n            buffer += decoder.decode(value, { stream: true });\r\n            const events = buffer.split(\"\\n\\n\");\r\n            buffer = events.pop() || \"\";\r\n            for (const event of events) {\r\n                if (!event.startsWith(\"data: \")) continue;\r\n                const payload = event.slice(6).trim();\r\n                try {\r\n                    const data = JSON.parse(payload);\r\n                    if (data.event === \"started\") {\r\n                        const batchTypes = mode === \"batch_three\" ? [\"global_explanation\", \"reasoning\", \"target_long\"] : [\"global_explanation\", \"reasoning\", \"target_short\", \"target_long\"];\r\n                        batchTypes.forEach(type => resultsDiv.appendChild(createSkeletonCard(type)));\r\n                    } else if (data.event === \"progress\") {\r\n                        updateCardWithData(data.type, data.data);\r\n                    } else if (data.event === \"error\") {\r\n                        if (data.type) showErrorInCard(data.type, data.error);\r\n                        else showToast(`Ïò§Î•ò: ${data.error}`, \"error\");\r\n                    } else if (data.event === \"done\") {\r\n                        const summary = data.success ? `‚úÖ ÏôÑÎ£å: ${data.completed}/${data.total} ÏÑ±Í≥µ` : \"‚ö†Ô∏è ÏùºÎ∂Ä Ïã§Ìå®\";\r\n                        showToast(summary, data.success ? \"success\" : \"warning\");\r\n                    }\r\n                } catch (parseError) {\r\n                    console.error(\"Failed to parse SSE event:\", payload, parseError);\r\n                }\r\n            }\r\n        }\r\n    } catch (error) {\r\n        console.error(\"Streaming error:\", error);\r\n        const message = error instanceof Error ? error.message : \"Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò\";\r\n        resultsDiv.innerHTML = `<div class=\"error-state\"><div class=\"error-state__icon\">‚ö†Ô∏è</div><h3 style=\"margin: 0 0 8px 0; color: var(--accent-danger);\">Ïä§Ìä∏Î¶¨Î∞ç Ïã§Ìå®</h3><p class=\"error-state__text\">${message}</p></div>`;\r\n        showToast(`Ïä§Ìä∏Î¶¨Î∞ç Ïò§Î•ò: ${message}`, \"error\");\r\n    }\r\n}\r\n\r\nfunction setupModeKeyboardNavigation(): void {\r\n    const radios = Array.from(document.querySelectorAll<HTMLInputElement>(\"input[name=\\\"mode\\\"]\"));\r\n    if (!radios.length) return;\r\n\r\n    const focusRadio = (index: number) => {\r\n        const target = radios[index];\r\n        target.focus();\r\n        target.checked = true;\r\n        target.dispatchEvent(new Event(\"change\", { bubbles: true }));\r\n    };\r\n\r\n    radios.forEach((radio, idx) => {\r\n        radio.addEventListener(\"keydown\", (e: KeyboardEvent) => {\r\n            let nextIndex = idx;\r\n            if (e.key === \"ArrowRight\" || e.key === \"ArrowDown\") {\r\n                nextIndex = (idx + 1) % radios.length;\r\n                e.preventDefault();\r\n                focusRadio(nextIndex);\r\n            } else if (e.key === \"ArrowLeft\" || e.key === \"ArrowUp\") {\r\n                nextIndex = (idx - 1 + radios.length) % radios.length;\r\n                e.preventDefault();\r\n                focusRadio(nextIndex);\r\n            } else if (e.key === \"Home\") {\r\n                e.preventDefault();\r\n                focusRadio(0);\r\n            } else if (e.key === \"End\") {\r\n                e.preventDefault();\r\n                focusRadio(radios.length - 1);\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\nexport function initQA(): void {\r\n    loadOCR();\r\n    document.getElementById(\"save-ocr-btn\")?.addEventListener(\"click\", () => saveOCR());\r\n\r\n    document.querySelectorAll(\"input[name=\\\"mode\\\"]\").forEach((radio) => {\r\n        radio.addEventListener(\"change\", (e) => {\r\n            const selector = document.getElementById(\"type-selector\");\r\n            if (selector) {\r\n                selector.style.display = (e.target as HTMLInputElement).value === \"single\" ? \"block\" : \"none\";\r\n            }\r\n        });\r\n    });\r\n\r\n    document.getElementById(\"generate-btn\")?.addEventListener(\"click\", async () => {\r\n        const modeInput = document.querySelector(\"input[name=\\\"mode\\\"]:checked\") as HTMLInputElement;\r\n        const mode = (modeInput?.value || \"single\") as GenerateMode;\r\n        const qtypeInput = document.getElementById(\"qtype\") as HTMLSelectElement;\r\n        const qtype = mode === \"single\" ? qtypeInput.value : null;\r\n        if (mode === \"batch\" || mode === \"batch_three\") {\r\n            await generateQAStreaming(mode);\r\n        } else {\r\n            await generateQA(mode, qtype);\r\n        }\r\n    });\r\n\r\n    setupModeKeyboardNavigation();\r\n\r\n    document.addEventListener(\"keydown\", (e) => {\r\n        if (e.key === \"Escape\" && activeController) {\r\n            activeController.abort();\r\n            showToast(\"ÏöîÏ≤≠ÏùÑ Ï∑®ÏÜåÌñàÏäµÎãàÎã§.\", \"warning\");\r\n        }\r\n    });\r\n}\r\n"],"names":["activeController","getModeLabels","mode","renderProgress","title","eta","escapeHtml","text","div","formatAnswer","formatted","getTypeBadge","type","copyToWorkspace","query","answer","isQAPair","value","candidate","extractPairs","raw","payload","candidates","_a","_b","displayResults","pairs","resultsDiv","allowed","p","emptyCard","emptyText","item","index","card","header","badge","querySection","queryLabel","queryContent","answerSection","answerLabel","answerContent","btnRow","copyBtn","generateQA","qtype","ocrText","showToast","stopProgress","showProgressWithEstimate","progressBar","validateRequest","validationError","ValidationError","result","withRetry","apiCall","resolve","error","message","createSkeletonCard","skeletonQuery","skeletonAnswer","updateCardWithData","data","showErrorInCard","icon","heading","generateQAStreaming","response","reader","decoder","buffer","done","events","event","summary","parseError","setupModeKeyboardNavigation","radios","focusRadio","target","radio","idx","e","nextIndex","initQA","loadOCR","saveOCR","selector","modeInput","qtypeInput"],"mappings":"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"}