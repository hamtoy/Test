import{s as g,a as C,w as q,b as k}from"../app.js";import{l as _,s as T}from"./ocr.js";import{validateRequest as N,ValidationError as L}from"./validation.js";let u=null;function A(n){return n==="batch"?{title:"âš¡ 4ê°œ íƒ€ì… ë™ì‹œ ìƒì„± ì¤‘...",eta:"30ì´ˆ~2ë¶„"}:n==="batch_three"?{title:"âš¡ 3ê°œ íƒ€ì… ë™ì‹œ ìƒì„± ì¤‘...",eta:"20ì´ˆ~90ì´ˆ"}:{title:"ğŸš€ ë‹µë³€ ìƒì„± ì¤‘...",eta:"15ì´ˆ~1ë¶„"}}function S(n){const{title:e,eta:t}=A(n);return`
        <div class="progress-container" style="text-align: center; padding: 40px 20px; background: var(--bg-secondary, #f5f5f5); border-radius: 8px;">
            <h3 style="margin-bottom: 20px; color: var(--text-primary, #333);">${e}</h3>
            <div style="margin: 25px auto; width: 320px; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                <div class="progress-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary, #21808d) 0%, var(--primary-dark, #1a6673) 100%); transition: width 0.5s ease;"></div>
            </div>
            <p style="color: var(--text-secondary, #666); font-size: 0.95em; margin-top: 20px; font-weight: 500;">ì˜ˆìƒ ì†Œìš” ì‹œê°„: <strong>${t}</strong></p>
            <p style="color: var(--text-secondary, #666); font-size: 0.85em; margin-top: 8px;">ë³‘ë ¬ ì²˜ë¦¬ë¡œ ë¹ ë¥´ê²Œ ì™„ë£Œë©ë‹ˆë‹¤ âœ¨</p>
        </div>
    `}function I(n){const e=document.createElement("div");return e.textContent=n||"",e.innerHTML}function w(n){const t=I(n).replaceAll(`

`,"<br><br>").replaceAll(`
`,"<br>").replaceAll(" - ","<br><br>- ");return window.DOMPurify?window.DOMPurify.sanitize(t):t}function v(n){return{explanation:"ğŸŒ ì „ë°˜ ì„¤ëª…",global_explanation:"ğŸŒ ì „ë°˜ ì„¤ëª…",reasoning:"ğŸ§  ì¶”ë¡ ",target_short:"ğŸ¯ íƒ€ê²Ÿ ë‹¨ë‹µ",target_long:"ğŸ“ íƒ€ê²Ÿ ì¥ë‹µ"}[n]||n}function E(n,e){sessionStorage.setItem("workspace_query",n),sessionStorage.setItem("workspace_answer",e),window.location.href="/workspace"}function M(n){if(!n||typeof n!="object")return!1;const e=n;return typeof e.type=="string"&&typeof e.query=="string"&&typeof e.answer=="string"}function $(n){var a,r;if(!n||typeof n!="object")return[];const e=n,t=[];return e.pairs&&t.push(...e.pairs),e.pair&&t.push(e.pair),(a=e.data)!=null&&a.pairs&&t.push(...e.data.pairs),(r=e.data)!=null&&r.pair&&t.push(e.data.pair),t.filter(M)}function B(n){var r;let e=$(n);const t=document.getElementById("results");if(!t)return;if(t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.innerHTML="",((r=document.querySelector('input[name="mode"]:checked'))==null?void 0:r.value)==="batch_three"){const o=new Set(["global_explanation","reasoning","target_long"]);e=e.filter(i=>o.has(i.type))}if(!e.length){const o=document.createElement("div");o.className="qa-card";const i=document.createElement("p");i.className="qa-empty-message",i.textContent="ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.",o.appendChild(i),t.appendChild(o);return}e.forEach((o,i)=>{const s=document.createElement("div");s.className="qa-card",s.style.animation=`slideIn 0.3s ease-out ${i*.05}s both`;const d=document.createElement("div");d.className="qa-header";const l=document.createElement("span");l.className="qa-type-badge",l.textContent=v(o.type),d.appendChild(l),s.appendChild(d);const p=document.createElement("div");p.className="qa-section";const m=document.createElement("strong");m.textContent="ğŸ’¬ ì§ˆì˜";const h=document.createElement("div");h.className="qa-content",h.textContent=o.query,p.appendChild(m),p.appendChild(h),s.appendChild(p);const c=document.createElement("div");c.className="qa-section";const y=document.createElement("strong");y.textContent="âœ¨ ë‹µë³€";const f=document.createElement("div");f.className="qa-content",f.innerHTML=w(o.answer),c.appendChild(y),c.appendChild(f),s.appendChild(c);const x=document.createElement("div");x.className="btn-row qa-btn-row";const b=document.createElement("button");b.className="btn-small qa-copy-btn",b.textContent="ğŸ“ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¡œ ë³µì‚¬",b.addEventListener("click",()=>{E(o.query||"",o.answer||"")}),x.appendChild(b),s.appendChild(x),t.appendChild(s)})}async function H(n,e){const t=document.getElementById("results");if(!t)return;const r=document.getElementById("ocr-input").value;if(!r.trim()){g("OCR í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.","error");return}t.innerHTML=S(n);const o=C(n==="batch"||n==="batch_three"?"batch":"single"),i=document.querySelector(".progress-fill");try{const s=n==="single"?{mode:"single",ocr_text:r,qtype:e||"global_explanation"}:{mode:"batch",ocr_text:r};n==="batch_three"&&(s.batch_types=["global_explanation","reasoning","target_long"]);try{N(s,"/api/qa/generate")}catch(l){if(l instanceof L){g(`ìš”ì²­ ê²€ì¦ ì‹¤íŒ¨: ${l.message}`,"error"),o(),t.innerHTML=`
                    <div style="text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;">
                        <h3 style="color: #f44336; margin-bottom: 10px;">âš ï¸ ìš”ì²­ ë°ì´í„° ì˜¤ë¥˜</h3>
                        <p style="color: #666; margin: 0; white-space: pre-line;">${l.message}</p>
                        <p style="color: #999; margin-top: 15px; font-size: 0.9em;">ğŸ’¡ í•„ë“œëª…ê³¼ ë°ì´í„° íƒ€ì…ì„ í™•ì¸í•˜ì„¸ìš”</p>
                    </div>
                `;return}throw l}u&&u.abort(),u=new AbortController;const d=await q(()=>k("/api/qa/generate","POST",s,u.signal),2,800);u=null,o(),i&&(i.style.width="100%"),await new Promise(l=>setTimeout(l,300)),B(d)}catch(s){u=null,o();const d=s instanceof Error?s.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";t.innerHTML=`
            <div style="text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;">
                <h3 style="color: #f44336; margin-bottom: 10px;">âŒ ìƒì„± ì‹¤íŒ¨</h3>
                <p style="color: #666; margin: 0;">${d}</p>
            </div>
        `}}function D(n){const e=document.createElement("div");e.className="qa-card",e.id=`qa-card-${n}`,e.setAttribute("aria-busy","true");const t=document.createElement("div");t.className="qa-type-badge",t.textContent=v(n),e.appendChild(t);const a=document.createElement("div");a.className="skeleton skeleton-text",a.style.cssText="height: 1.5em; width: 80%; margin: 16px 0",e.appendChild(a);const r=document.createElement("div");return r.className="skeleton skeleton-block",r.style.cssText="height: 100px; margin: 16px 0",e.appendChild(r),e}function R(n,e){const t=document.getElementById(`qa-card-${n}`);if(!t)return;t.removeAttribute("aria-busy"),t.innerHTML="";const a=document.createElement("div");a.className="qa-type-badge",a.textContent=v(n),t.appendChild(a);const r=document.createElement("div");r.className="qa-section";const o=document.createElement("strong");o.textContent="ğŸ’¬ ì§ˆì˜";const i=document.createElement("div");i.className="qa-content",i.textContent=e.query,r.appendChild(o),r.appendChild(i),t.appendChild(r);const s=document.createElement("div");s.className="qa-section";const d=document.createElement("strong");d.textContent="âœ¨ ë‹µë³€";const l=document.createElement("div");l.className="qa-content",l.innerHTML=w(e.answer),s.appendChild(d),s.appendChild(l),t.appendChild(s);const p=document.createElement("div");p.className="btn-row qa-btn-row";const m=document.createElement("button");m.className="btn-small qa-copy-btn",m.textContent="ğŸ“ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¡œ ë³µì‚¬",m.addEventListener("click",()=>E(e.query,e.answer)),p.appendChild(m),t.appendChild(p)}function P(n,e){const t=document.getElementById(`qa-card-${n}`);if(!t)return;t.removeAttribute("aria-busy"),t.innerHTML="",t.className="qa-card error-state",t.setAttribute("role","alert");const a=document.createElement("div");a.className="error-state__icon",a.textContent="âš ï¸",t.appendChild(a);const r=document.createElement("h3");r.style.cssText="margin: 0 0 8px 0; color: var(--accent-danger);",r.textContent=`${v(n)} ìƒì„± ì‹¤íŒ¨`,t.appendChild(r);const o=document.createElement("p");o.className="error-state__text",o.textContent=e,t.appendChild(o)}async function O(n){const e=document.getElementById("results");if(!e)return;const a=document.getElementById("ocr-input").value;if(!a.trim()){g("OCR í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.","error");return}e.innerHTML="";try{const r=await fetch("/api/qa/generate/batch/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:n,ocr_text:a}),signal:u==null?void 0:u.signal});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);if(!r.body)throw new Error("No response body");const o=r.body.getReader(),i=new TextDecoder;let s="";for(;;){const{done:d,value:l}=await o.read();if(d)break;s+=i.decode(l,{stream:!0});const p=s.split(`

`);s=p.pop()||"";for(const m of p){if(!m.startsWith("data: "))continue;const h=m.slice(6).trim();try{const c=JSON.parse(h);if(c.event==="started")(n==="batch_three"?["global_explanation","reasoning","target_long"]:["global_explanation","reasoning","target_short","target_long"]).forEach(f=>e.appendChild(D(f)));else if(c.event==="progress")R(c.type,c.data);else if(c.event==="error")c.type?P(c.type,c.error):g(`ì˜¤ë¥˜: ${c.error}`,"error");else if(c.event==="done"){const y=c.success?`âœ… ì™„ë£Œ: ${c.completed}/${c.total} ì„±ê³µ`:"âš ï¸ ì¼ë¶€ ì‹¤íŒ¨";g(y,c.success?"success":"warning")}}catch(c){console.error("Failed to parse SSE event:",h,c)}}}}catch(r){console.error("Streaming error:",r);const o=r instanceof Error?r.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";e.innerHTML=`<div class="error-state"><div class="error-state__icon">âš ï¸</div><h3 style="margin: 0 0 8px 0; color: var(--accent-danger);">ìŠ¤íŠ¸ë¦¬ë° ì‹¤íŒ¨</h3><p class="error-state__text">${o}</p></div>`,g(`ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜: ${o}`,"error")}}function Q(){const n=Array.from(document.querySelectorAll('input[name="mode"]'));if(!n.length)return;const e=t=>{const a=n[t];a.focus(),a.checked=!0,a.dispatchEvent(new Event("change",{bubbles:!0}))};n.forEach((t,a)=>{t.addEventListener("keydown",r=>{let o=a;r.key==="ArrowRight"||r.key==="ArrowDown"?(o=(a+1)%n.length,r.preventDefault(),e(o)):r.key==="ArrowLeft"||r.key==="ArrowUp"?(o=(a-1+n.length)%n.length,r.preventDefault(),e(o)):r.key==="Home"?(r.preventDefault(),e(0)):r.key==="End"&&(r.preventDefault(),e(n.length-1))})})}function J(){var n,e;_(),(n=document.getElementById("save-ocr-btn"))==null||n.addEventListener("click",()=>T()),document.querySelectorAll('input[name="mode"]').forEach(t=>{t.addEventListener("change",a=>{const r=document.getElementById("type-selector");r&&(r.style.display=a.target.value==="single"?"block":"none")})}),(e=document.getElementById("generate-btn"))==null||e.addEventListener("click",async()=>{const t=document.querySelector('input[name="mode"]:checked'),a=(t==null?void 0:t.value)||"single",r=document.getElementById("qtype"),o=a==="single"?r.value:null;a==="batch"||a==="batch_three"?await O(a):await H(a,o)}),Q(),document.addEventListener("keydown",t=>{t.key==="Escape"&&u&&(u.abort(),g("ìš”ì²­ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.","warning"))})}export{J as initQA};
//# sourceMappingURL=qa.js.map
