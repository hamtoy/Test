name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  pull-requests: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13"]

    env:
      NEO4J_URI: bolt://localhost:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: testpassword

    services:
      neo4j:
        image: neo4j:latest
        env:
          NEO4J_AUTH: neo4j/testpassword
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "wget -q --spider http://localhost:7474 || exit 1"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 30s

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.4.x"
          enable-cache: true
          cache-dependency-glob: |
            uv.lock
            pyproject.toml

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Ruff lint
        run: uv run ruff check .

      - name: Ruff format check
        run: uv run ruff format --check .

      - name: Check unused imports (autoflake)
        run: uv run autoflake --check --remove-all-unused-imports --ignore-pass-statements --recursive src/

      - name: Check dead code (vulture)
        run: uv run vulture src/ scripts/vulture_whitelist.py --min-confidence=80

      - name: Mypy
        run: uv run mypy .

      - name: Pydocstyle (Google convention)
        run: uv run pydocstyle --convention=google --add-ignore=D100,D104,D403 src/
        continue-on-error: false # Fail CI if docstring issues found

      - name: Wait for Neo4j
        run: |
          for i in {1..30}; do
            uv run python - <<'PY'
              import sys
              from neo4j import GraphDatabase
              uri = "bolt://localhost:7687"
              auth = ("neo4j", "testpassword")
              try:
                  driver = GraphDatabase.driver(uri, auth=auth)
                  with driver.session() as session:
                      session.run("RETURN 1")
                  driver.close()
                  sys.exit(0)
              except Exception as e:
                  print(f"Neo4j not ready: {e}")
                  sys.exit(1)
            PY
            status=$?
            if [ $status -eq 0 ]; then
              exit 0
            fi
            sleep 5
          done
          echo "Neo4j did not become ready in time"
          exit 1

      - name: Test v3.0 public API imports
        run: |
          echo "ðŸ” Testing v3.0 public API imports..."
          uv run python - <<'PY'
            from src import __version__
            from src.agent import GeminiAgent
            from src.core.models import WorkflowResult, EvaluationResultSchema, QueryResult
            from src.config import AppConfig
            from src.config.exceptions import BudgetExceededError, APIRateLimitError, ValidationFailedError

            print(f"âœ… All v3.0 imports successful (version: {__version__})")
        PY

      - name: Pytest
        run: uv run pytest -s --cov=src --cov-report=xml --cov-fail-under=75

      - name: Upload coverage to Codecov (optional)
        uses: codecov/codecov-action@v5
        if: env.CODECOV_TOKEN != ''
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  e2e-tests:
    runs-on: ubuntu-latest
    needs: test # ìœ ë‹› í…ŒìŠ¤íŠ¸ í†µê³¼ í›„ ì‹¤í–‰
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.GEMINI_API_KEY != ''
    services:
      neo4j:
        image: neo4j:latest
        env:
          NEO4J_AUTH: neo4j/testpassword
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "wget -q --spider http://localhost:7474 || exit 1"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 30s
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.4.x"
          enable-cache: true
          cache-dependency-glob: |
            uv.lock
            pyproject.toml

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Wait for Neo4j (e2e)
        run: |
          for i in {1..30}; do
            uv run python - <<'PY'
              import sys
              from neo4j import GraphDatabase
              uri = "bolt://localhost:7687"
              auth = ("neo4j", "testpassword")
              try:
                  driver = GraphDatabase.driver(uri, auth=auth)
                  with driver.session() as session:
                      session.run("RETURN 1")
                  driver.close()
                  sys.exit(0)
              except Exception as e:
                  print(f"Neo4j not ready: {e}")
                  sys.exit(1)
PY
            status=$?
            if [ $status -eq 0 ]; then
              exit 0
            fi
            sleep 5
          done
          echo "Neo4j did not become ready in time"
          exit 1

      - name: Run E2E tests
        run: uv run pytest tests/ -v -m e2e
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NEO4J_URI: "bolt://localhost:7687"
          NEO4J_USER: "neo4j"
          NEO4J_PASSWORD: "testpassword"
          REDIS_URL: "redis://localhost:6379"
