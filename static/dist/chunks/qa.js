import{s as h,a as x,w,b as E}from"../app.js";import{l as q,s as C}from"./ocr.js";import{validateRequest as k,ValidationError as _}from"./validation.js";let l=null;function L(e){return e==="batch"?{title:"âš¡ 4ê°œ íƒ€ì… ë™ì‹œ ìƒì„± ì¤‘...",eta:"30ì´ˆ~2ë¶„"}:e==="batch_three"?{title:"âš¡ 3ê°œ íƒ€ì… ë™ì‹œ ìƒì„± ì¤‘...",eta:"20ì´ˆ~90ì´ˆ"}:{title:"ğŸš€ ë‹µë³€ ìƒì„± ì¤‘...",eta:"15ì´ˆ~1ë¶„"}}function A(e){const{title:t,eta:n}=L(e);return`
        <div class="progress-container" style="text-align: center; padding: 40px 20px; background: var(--bg-secondary, #f5f5f5); border-radius: 8px;">
            <h3 style="margin-bottom: 20px; color: var(--text-primary, #333);">${t}</h3>
            <div style="margin: 25px auto; width: 320px; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                <div class="progress-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary, #21808d) 0%, var(--primary-dark, #1a6673) 100%); transition: width 0.5s ease;"></div>
            </div>
            <p style="color: var(--text-secondary, #666); font-size: 0.95em; margin-top: 20px; font-weight: 500;">ì˜ˆìƒ ì†Œìš” ì‹œê°„: <strong>${n}</strong></p>
            <p style="color: var(--text-secondary, #666); font-size: 0.85em; margin-top: 8px;">ë³‘ë ¬ ì²˜ë¦¬ë¡œ ë¹ ë¥´ê²Œ ì™„ë£Œë©ë‹ˆë‹¤ âœ¨</p>
        </div>
    `}function I(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}function T(e){const n=I(e).replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>").replace(/ - /g,"<br><br>- ");return window.DOMPurify?window.DOMPurify.sanitize(n):n}function M(e){return{explanation:"ğŸŒ ì „ë°˜ ì„¤ëª…",global_explanation:"ğŸŒ ì „ë°˜ ì„¤ëª…",reasoning:"ğŸ§  ì¶”ë¡ ",target_short:"ğŸ¯ íƒ€ê²Ÿ ë‹¨ë‹µ",target_long:"ğŸ“ íƒ€ê²Ÿ ì¥ë‹µ"}[e]||e}function N(e,t){sessionStorage.setItem("workspace_query",e),sessionStorage.setItem("workspace_answer",t),window.location.href="/workspace"}function S(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.type=="string"&&typeof t.query=="string"&&typeof t.answer=="string"}function B(e){var o,r;if(!e||typeof e!="object")return[];const t=e,n=[];return t.pairs&&n.push(...t.pairs),t.pair&&n.push(t.pair),(o=t.data)!=null&&o.pairs&&n.push(...t.data.pairs),(r=t.data)!=null&&r.pair&&n.push(t.data.pair),n.filter(S)}function D(e){var r;let t=B(e);const n=document.getElementById("results");if(!n)return;if(n.setAttribute("role","status"),n.setAttribute("aria-live","polite"),n.innerHTML="",((r=document.querySelector('input[name="mode"]:checked'))==null?void 0:r.value)==="batch_three"){const a=new Set(["global_explanation","reasoning","target_long"]);t=t.filter(i=>a.has(i.type))}if(!t.length){const a=document.createElement("div");a.className="qa-card";const i=document.createElement("p");i.className="qa-empty-message",i.textContent="ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.",a.appendChild(i),n.appendChild(a);return}t.forEach((a,i)=>{const s=document.createElement("div");s.className="qa-card",s.style.animation=`slideIn 0.3s ease-out ${i*.05}s both`;const d=document.createElement("div");d.className="qa-header";const c=document.createElement("span");c.className="qa-type-badge",c.textContent=M(a.type),d.appendChild(c),s.appendChild(d);const p=document.createElement("div");p.className="qa-section";const b=document.createElement("strong");b.textContent="ğŸ’¬ ì§ˆì˜";const g=document.createElement("div");g.className="qa-content",g.textContent=a.query,p.appendChild(b),p.appendChild(g),s.appendChild(p);const u=document.createElement("div");u.className="qa-section";const v=document.createElement("strong");v.textContent="âœ¨ ë‹µë³€";const y=document.createElement("div");y.className="qa-content",y.innerHTML=T(a.answer),u.appendChild(v),u.appendChild(y),s.appendChild(u);const f=document.createElement("div");f.className="btn-row qa-btn-row";const m=document.createElement("button");m.className="btn-small qa-copy-btn",m.textContent="ğŸ“ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¡œ ë³µì‚¬",m.addEventListener("click",()=>{N(a.query||"",a.answer||"")}),f.appendChild(m),s.appendChild(f),n.appendChild(s)})}async function P(e,t){const n=document.getElementById("results");if(!n)return;const r=document.getElementById("ocr-input").value;if(!r.trim()){h("OCR í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.","error");return}n.innerHTML=A(e);const a=x(e==="batch"||e==="batch_three"?"batch":"single"),i=document.querySelector(".progress-fill");try{const s=e==="single"?{mode:"single",ocr_text:r,qtype:t||"global_explanation"}:{mode:"batch",ocr_text:r};e==="batch_three"&&(s.batch_types=["global_explanation","reasoning","target_long"]);try{k(s,"/api/qa/generate")}catch(c){if(c instanceof _){h(`ìš”ì²­ ê²€ì¦ ì‹¤íŒ¨: ${c.message}`,"error"),a(),n.innerHTML=`
                    <div style="text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;">
                        <h3 style="color: #f44336; margin-bottom: 10px;">âš ï¸ ìš”ì²­ ë°ì´í„° ì˜¤ë¥˜</h3>
                        <p style="color: #666; margin: 0; white-space: pre-line;">${c.message}</p>
                        <p style="color: #999; margin-top: 15px; font-size: 0.9em;">ğŸ’¡ í•„ë“œëª…ê³¼ ë°ì´í„° íƒ€ì…ì„ í™•ì¸í•˜ì„¸ìš”</p>
                    </div>
                `;return}throw c}l&&l.abort(),l=new AbortController;const d=await w(()=>E("/api/qa/generate","POST",s,l.signal),2,800);l=null,a(),i&&(i.style.width="100%"),await new Promise(c=>setTimeout(c,300)),D(d)}catch(s){l=null,a();const d=s instanceof Error?s.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";n.innerHTML=`
            <div style="text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;">
                <h3 style="color: #f44336; margin-bottom: 10px;">âŒ ìƒì„± ì‹¤íŒ¨</h3>
                <p style="color: #666; margin: 0;">${d}</p>
            </div>
        `}}function R(){const e=Array.from(document.querySelectorAll('input[name="mode"]'));if(!e.length)return;const t=n=>{const o=e[n];o.focus(),o.checked=!0,o.dispatchEvent(new Event("change",{bubbles:!0}))};e.forEach((n,o)=>{n.addEventListener("keydown",r=>{let a=o;r.key==="ArrowRight"||r.key==="ArrowDown"?(a=(o+1)%e.length,r.preventDefault(),t(a)):r.key==="ArrowLeft"||r.key==="ArrowUp"?(a=(o-1+e.length)%e.length,r.preventDefault(),t(a)):r.key==="Home"?(r.preventDefault(),t(0)):r.key==="End"&&(r.preventDefault(),t(e.length-1))})})}function z(){var e,t;q(),(e=document.getElementById("save-ocr-btn"))==null||e.addEventListener("click",()=>C()),document.querySelectorAll('input[name="mode"]').forEach(n=>{n.addEventListener("change",o=>{const r=document.getElementById("type-selector");r&&(r.style.display=o.target.value==="single"?"block":"none")})}),(t=document.getElementById("generate-btn"))==null||t.addEventListener("click",async()=>{const n=document.querySelector('input[name="mode"]:checked'),o=(n==null?void 0:n.value)||"single",r=document.getElementById("qtype"),a=o==="single"?r.value:null;await P(o,a)}),R(),document.addEventListener("keydown",n=>{n.key==="Escape"&&l&&(l.abort(),h("ìš”ì²­ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.","warning"))})}export{z as initQA};
//# sourceMappingURL=qa.js.map
