<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë¯¸ì§€ ë¶„ì„ - Gemini QA System</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <h1>ğŸ¤– Gemini QA System</h1>
        <nav>
            <a href="/qa">QA ìƒì„±</a>
            <a href="/eval">ì™¸ë¶€ í‰ê°€</a>
            <a href="/workspace">ì›Œí¬ìŠ¤í˜ì´ìŠ¤</a>
            <a href="/multimodal" class="active">ì´ë¯¸ì§€ ë¶„ì„</a>
        </nav>
    </header>

    <main>
        <section class="card">
            <h2>ì´ë¯¸ì§€ ë¶„ì„</h2>
            <p>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ OCR ë° êµ¬ì¡° ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>
            <form id="upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file">ì´ë¯¸ì§€ íŒŒì¼</label>
                    <input type="file" id="file" name="file" accept="image/*" required>
                </div>

                <button type="submit">ë¶„ì„í•˜ê¸°</button>
            </form>
        </section>

        <section class="card" id="result-section" style="display:none;">
            <h2>ë¶„ì„ ê²°ê³¼</h2>
            <div id="result"></div>
        </section>
    </main>

    <script>
        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('file');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch('/api/multimodal/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();

                const resultSection = document.getElementById('result-section');
                const resultDiv = document.getElementById('result');

                if (res.ok) {
                    let html = `<h3>${data.filename}</h3>`;
                    html += '<dl>';
                    html += `<dt>í…ìŠ¤íŠ¸ ë°€ë„</dt><dd>${data.metadata.text_density?.toFixed(2) || 'N/A'}</dd>`;
                    html += `<dt>í‘œ/ê·¸ë˜í”„</dt><dd>${data.metadata.has_table_chart ? 'ìˆìŒ' : 'ì—†ìŒ'}</dd>`;
                    html += `<dt>ì£¼ìš” ì£¼ì œ</dt><dd>${(data.metadata.topics || []).join(', ') || 'N/A'}</dd>`;
                    html += '</dl>';

                    if (data.metadata.extracted_text) {
                        html += '<h4>ì¶”ì¶œëœ í…ìŠ¤íŠ¸</h4>';
                        html += `<pre>${data.metadata.extracted_text}</pre>`;
                    }

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p class="error">${data.detail || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</p>`;
                }

                resultSection.style.display = 'block';
            } catch (err) {
                console.error(err);
                alert('ìš”ì²­ ì‹¤íŒ¨: ' + err.message);
            }
        });
    </script>
</body>
</html>
{% extends "layout.html" %}

{% block content %}
<div class="split-layout">
    <!-- ì™¼ìª½: ì—…ë¡œë“œ ì˜ì—­ -->
    <div class="left-panel">
        <h2>ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>
        
        <div id="drop-zone" class="drop-zone">
            <p>ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
            <input type="file" id="file-input" accept="image/*" style="display:none">
        </div>

        <button id="analyze-btn" class="btn-primary" disabled>ğŸ” ë¶„ì„ ì‹¤í–‰</button>

        <div id="preview-area"></div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ë¶„ì„ ê²°ê³¼ -->
    <div class="right-panel">
        <h2>ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>
        <div id="analysis-results" class="results-area"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedFile = null;

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const analyzeBtn = document.getElementById('analyze-btn');

    // í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ
    dropZone.addEventListener('click', () => fileInput.click());

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#4CAF50';
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.borderColor = '#666';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#666';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    // íŒŒì¼ ì„ íƒ
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    function handleFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        selectedFile = file;
        analyzeBtn.disabled = false;

        // ë¯¸ë¦¬ë³´ê¸° - DOM methodë¡œ ì•ˆì „í•˜ê²Œ ìƒì„±
        const reader = new FileReader();
        reader.onload = (e) => {
            const previewArea = document.getElementById('preview-area');
            previewArea.innerHTML = '';
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.cssText = 'max-width:100%; margin-top:10px;';
            previewArea.appendChild(img);
        };
        reader.readAsDataURL(file);
    }

    // ë¶„ì„ ì‹¤í–‰
    analyzeBtn.addEventListener('click', async () => {
        if (!selectedFile) return;
        await analyzeImage(selectedFile);
    });
</script>
{% endblock %}
