name: Weekly Report

on:
  schedule:
    - cron: "0 0 * * 1" # Every Monday at midnight UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  generate-report:
    name: Generate Weekly Report
    runs-on: ubuntu-latest
    outputs:
      total_calls: ${{ steps.analyze.outputs.total_calls }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.4.x"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Analyze deprecation usage
        id: analyze
        run: |
          # Run analysis and capture output
          uv run python scripts/deprecation_stats.py \
            --path . \
            --exclude .venv \
            --exclude __pycache__ \
            --exclude .git \
            --html deprecation_report.html \
            --json deprecation_stats.json

          # Extract total calls from JSON for threshold check
          TOTAL_CALLS=$(python -c "import json; print(json.load(open('deprecation_stats.json'))['stats']['total_calls'])")
          echo "total_calls=${TOTAL_CALLS}" >> $GITHUB_OUTPUT
          echo "üìä Total deprecated calls: ${TOTAL_CALLS}"

      - name: Upload HTML Report
        uses: actions/upload-artifact@v5
        with:
          name: weekly-deprecation-report
          path: deprecation_report.html
          retention-days: 90

      - name: Upload JSON Stats
        uses: actions/upload-artifact@v5
        with:
          name: deprecation-stats-json
          path: deprecation_stats.json
          retention-days: 90

  create-issue-if-needed:
    name: Create Issue for High Usage
    runs-on: ubuntu-latest
    needs: generate-report
    if: needs.generate-report.outputs.total_calls > 100
    steps:
      - name: Create Issue
        uses: actions/github-script@v8
        with:
          script: |
            const totalCalls = ${{ needs.generate-report.outputs.total_calls }};
            const date = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ö†Ô∏è High Deprecated Import Usage Detected (${date})`,
              body: `## Deprecation Report Summary

            **Date**: ${date}
            **Total Deprecated Calls**: ${totalCalls}

            ### Action Required

            The number of deprecated import usages exceeds the threshold of 100.
            Please review the weekly report artifact and prioritize migration.

            ### Migration Steps

            1. Download the HTML report from the workflow artifacts
            2. Review the affected files
            3. Run the migration tool:
               \`\`\`bash
               python scripts/migrate_imports.py --check --path src/
               python scripts/migrate_imports.py --fix --path src/
               \`\`\`

            ### Resources

            - [DEPRECATION.md](DEPRECATION.md) - Deprecation details
            - [MIGRATION.md](MIGRATION.md) - Migration guide

            ---
            *This issue was automatically created by the Weekly Deprecation Report workflow.*`,
              labels: ['deprecation', 'maintenance', 'automated']
            });
