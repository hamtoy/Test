{% extends "layout.html" %}

{% block content %}
<div class="split-layout">
    <!-- ì™¼ìª½: OCR ì˜ì—­ -->
    <div class="left-panel">
    <h2>ğŸ“„ OCR í…ìŠ¤íŠ¸</h2>
    <textarea id="ocr-input" class="ocr-box" rows="15" placeholder="OCR í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    <div class="btn-row">
        <button id="save-ocr-btn" class="btn-primary" style="width: 100%;">ğŸ’¾ ì €ì¥</button>
    </div>
    <span id="ocr-save-status" class="status-text"></span>

    <!-- ì „ì²´ ì„¤ëª…ë¬¸ ì°¸ì¡° ì˜ì—­ -->
    <div class="reference-section" style="margin-top: 20px;">
        <div class="reference-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h3 style="margin: 0; font-size: 14px; color: var(--text-primary, #333);">ğŸ“ ì „ì²´ ì„¤ëª…ë¬¸ (ì°¸ì¡°ìš©)</h3>
            <button id="clear-reference-btn" class="btn-small" type="button" style="padding: 4px 8px; font-size: 11px;">ì§€ìš°ê¸°</button>
        </div>
        <textarea
            id="global-explanation-ref"
            class="reference-box"
            rows="8"
            placeholder="ì „ì²´ ì„¤ëª…ë¬¸ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.\n\níƒ€ê²Ÿ ë‹¨ë‹µí˜•/ì¥ë‹µí˜• ìƒì„± ì‹œ ì´ ë‚´ìš©ê³¼ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ì§ˆì˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."
            style="width: 100%; padding: 10px; font-size: 13px; border: 1px dashed var(--border, #ccc); border-radius: 6px; background: var(--bg-secondary, #f9f9f9); resize: vertical;"
        ></textarea>
        <small style="display: block; margin-top: 6px; color: var(--text-secondary, #888); font-size: 12px;">
            ğŸ’¡ QA ìƒì„± ê²°ê³¼ì—ì„œ ì „ì²´ ì„¤ëª…ë¬¸ì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
        </small>
    </div>
</div>

    <!-- ì˜¤ë¥¸ìª½: í†µí•© ì›Œí¬ìŠ¤í˜ì´ìŠ¤ -->
    <div class="right-panel">
        <h2>ğŸ”¥ ì›Œí¬ìŠ¤í˜ì´ìŠ¤</h2>
        
        <!-- ì§ˆì˜ (ì„ íƒ) -->
        <div class="form-group">
            <label for="query">ì§ˆì˜ (ì„ íƒ)</label>
            <div class="input-with-copy">
                <textarea id="query" rows="3" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ë¹„ìš°ë©´ OCRì—ì„œ ìë™ ìƒì„±)"></textarea>
                <button type="button" class="copy-btn-float" onclick="copyFieldContent('query', this)">ğŸ“‹ ë³µì‚¬</button>
            </div>
            <small style="color: var(--text-secondary, #666); font-size: 0.85em;">
                ğŸ’¡ ë¹„ì›Œë‘ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤
            </small>
        </div>

        <!-- ë‹µë³€ (ì„ íƒ) -->
        <div class="form-group">
            <label for="answer">ë‹µë³€ (ì„ íƒ)</label>
            <div class="input-with-copy">
                <textarea id="answer" rows="8" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš” (ë¹„ìš°ë©´ ì§ˆë¬¸ ê¸°ë°˜ ìë™ ìƒì„±)"></textarea>
                <button type="button" class="copy-btn-float" onclick="copyFieldContent('answer', this)">ğŸ“‹ ë³µì‚¬</button>
            </div>
            <small style="color: var(--text-secondary, #666); font-size: 0.85em;">
                ğŸ’¡ ë¹„ì›Œë‘ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤
            </small>
        </div>

        <!-- ì§ˆë¬¸/ë‹µë³€ ìœ í˜• ì„ íƒ -->
        <div class="form-group">
            <label for="query-type">ì§ˆë¬¸/ë‹µë³€ ìœ í˜• (ì„ íƒ)</label>
            <select
                id="query-type"
                style="width: 100%; padding: 12px; border: 1px solid var(--border, rgba(94, 82, 64, 0.2)); border-radius: 6px; font-size: 14px; background: var(--surface, #fffffe); color: var(--text-primary, #1f2121);"
            >
                <option value="">ìë™ ê°ì§€</option>
                <option value="global_explanation">ì „ë°˜ ì„¤ëª…</option>
                <option value="reasoning">ì¶”ë¡ </option>
                <option value="target_short">íƒ€ê²Ÿ ë‹¨ë‹µ</option>
                <option value="target_long">íƒ€ê²Ÿ ì¥ë‹µ</option>
            </select>
            <small style="color: var(--text-secondary, #666); font-size: 0.85em;">
                ğŸ¯ ìƒì„±í•  ì§ˆì˜/ë‹µë³€ì˜ ìŠ¤íƒ€ì¼ì„ ì§€ì •í•©ë‹ˆë‹¤
            </small>
        </div>

        <!-- ìˆ˜ì • ìš”ì²­ (ì„ íƒ) -->
        <div class="form-group">
            <label for="edit-request">ìˆ˜ì • ìš”ì²­ (ì„ íƒ)</label>
            <input type="text" id="edit-request" placeholder="ì˜ˆ: ë” ê°„ê²°í•˜ê²Œ, ìˆ«ì ê°•ì¡°, ë¬¸ì¥ ë‹¤ë“¬ê¸°...">
            <small style="color: var(--text-secondary, #666); font-size: 0.85em;">
                âœï¸ ì§ˆì˜ë‚˜ ë‹µë³€ì„ ìˆ˜ì •í•˜ê³  ì‹¶ì„ ë•Œ ì…ë ¥í•˜ì„¸ìš”
            </small>
        </div>

        <!-- ì‹¤í–‰ ë²„íŠ¼ -->
        <button id="execute-btn" class="btn-primary" style="width: 100%; padding: 14px; font-size: 16px; font-weight: 600;">
            ğŸš€ ì‹¤í–‰
        </button>

        <!-- ê²°ê³¼ ì˜ì—­ -->
        <div id="workspace-results" class="results-area" aria-live="polite" aria-atomic="true"></div>
    </div>
</div>

<style>
    .form-group {
        margin-bottom: 24px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-primary, #1f2121);
        font-size: 14px;
    }

    .form-group textarea,
    .form-group input[type="text"] {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border, rgba(94, 82, 64, 0.2));
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
        background: var(--surface, #fffffe);
        color: var(--text-primary, #1f2121);
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group textarea:focus,
    .form-group input[type="text"]:focus {
        outline: none;
        border-color: var(--primary, #21808d);
        box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1);
    }

    .form-group textarea {
        resize: vertical;
    }

    .form-group small {
        display: block;
        margin-top: 6px;
    }

    .workflow-badge {
        display: inline-block;
        padding: 6px 14px;
        background: var(--primary, #21808d);
        color: white;
        border-radius: 5px;
        font-size: 0.85em;
        font-weight: 600;
        margin-bottom: 12px;
    }

    .result-card {
        background: var(--surface, #fffffe);
        border: 1px solid var(--border, rgba(94, 82, 64, 0.12));
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }

    .result-section {
        margin: 15px 0;
        padding: 12px;
        background: var(--bg-secondary, #f5f5f5);
        border-radius: 5px;
        border-left: 3px solid var(--primary, #21808d);
    }

    .result-section strong {
        display: block;
        margin-bottom: 8px;
        color: var(--text-primary, #1f2121);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // OCR ë¡œë“œ/ì €ì¥
    function setButtonLoading(button, isLoading) {
        if (!button) return;
        button.disabled = isLoading;
        button.setAttribute('aria-busy', String(isLoading));
        if (isLoading) {
            button.dataset.originalText = button.dataset.originalText || button.textContent;
            button.setAttribute('aria-label', 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
            button.textContent = 'â³ ì²˜ë¦¬ ì¤‘...';
            button.style.opacity = '0.6';
        } else {
            button.textContent = button.dataset.originalText || button.textContent;
            button.setAttribute('aria-label', 'ì‹¤í–‰');
            button.style.opacity = '1';
            button.removeAttribute('aria-busy');
        }
    }

    async function loadOCR() {
        try {
            const data = await apiCall('/api/ocr');
            document.getElementById('ocr-input').value = data.ocr || '';
        } catch (error) {
            document.getElementById('ocr-input').placeholder = 'OCR ë¡œë“œ ì‹¤íŒ¨';
        }
    }

    async function saveOCR() {
        const text = document.getElementById('ocr-input').value;
        const statusEl = document.getElementById('ocr-save-status');
        try {
            await apiCall('/api/ocr', 'POST', { text });
            statusEl.textContent = 'âœ… ì €ì¥ë¨';
            statusEl.style.color = 'var(--success, green)';
            setTimeout(() => statusEl.textContent = '', 2000);
        } catch (error) {
            statusEl.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨';
            statusEl.style.color = 'var(--danger, red)';
        }
    }

    // ì‹¤í–‰ ë²„íŠ¼ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
    let isExecuting = false;
    let abortController = null;

    document.getElementById('execute-btn').addEventListener('click', async () => {
        if (isExecuting) {
            console.log('ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.');
            return;
        }
        const executeBtn = document.getElementById('execute-btn');
        if (abortController) {
            abortController.abort();
        }
        abortController = new AbortController();

        const query = document.getElementById('query').value.trim();
        const answer = document.getElementById('answer').value.trim();
        const editRequest = document.getElementById('edit-request').value.trim();
        const ocrText = document.getElementById('ocr-input').value;
        const queryType = document.getElementById('query-type').value;
        const globalExplanationRef = document.getElementById('global-explanation-ref').value.trim();

        const resultsDiv = document.getElementById('workspace-results');
        
        // ì§„í–‰ ìƒí™© í‘œì‹œ
        resultsDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; background: var(--bg-secondary, #f5f5f5); border-radius: 8px; margin-top: 20px;">
                <p style="color: var(--text-primary, #1f2121); margin: 0;">â³ ì²˜ë¦¬ ì¤‘...</p>
            </div>
        `;

        isExecuting = true;
        setButtonLoading(executeBtn, true);

        try {
            const result = await apiCall('/api/workspace/unified', 'POST', {
                query: query || null,
                answer: answer || null,
                edit_request: editRequest || null,
                ocr_text: ocrText || null,
                query_type: queryType || null,
                global_explanation_ref: globalExplanationRef || null,
            }, abortController?.signal);

            displayResult(result);
        } catch (error) {
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;">
                    <p style="color: #f44336; margin: 0;">âŒ ì‘ì—… ì‹¤íŒ¨: ${error.message}</p>
                    <button type="button" class="btn-secondary" onclick="document.getElementById('execute-btn').click()">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>
                </div>
            `;
        } finally {
            isExecuting = false;
            setButtonLoading(executeBtn, false);
        }
    });

    function displayResult(data) {
        // ì§ˆì˜/ë‹µë³€ì„ ì…ë ¥ í•„ë“œì— ì§ì ‘ ì±„ìš°ê¸° + í•˜ì´ë¼ì´íŠ¸
        if (data.query) {
            const queryField = document.getElementById('query');
            queryField.value = data.query;
            queryField.style.borderColor = 'var(--primary, #21808d)';
            queryField.style.boxShadow = '0 0 0 3px rgba(33, 128, 141, 0.2)';
            setTimeout(() => {
                queryField.style.borderColor = '';
                queryField.style.boxShadow = '';
            }, 2000);
        }

        if (data.answer) {
            const answerField = document.getElementById('answer');
            answerField.value = data.answer;
            answerField.style.borderColor = 'var(--primary, #21808d)';
            answerField.style.boxShadow = '0 0 0 3px rgba(33, 128, 141, 0.2)';
            setTimeout(() => {
                answerField.style.borderColor = '';
                answerField.style.boxShadow = '';
            }, 2000);
        }

        // ê°„ë‹¨í•œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ ìë™ ì œê±°
        const resultsDiv = document.getElementById('workspace-results');
        resultsDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; background: #e8f5e9; border-radius: 8px; border: 1px solid #4caf50; margin-top: 20px; animation: fadeIn 0.3s;">
                <h3 style="margin: 0 0 10px 0; color: #4caf50;">âœ… ${getWorkflowLabel(data.workflow)} ì™„ë£Œ</h3>
                <p style="margin: 0; color: #666; font-size: 0.9em;">
                    ${data.query ? 'ì§ˆì˜' : ''}${data.query && data.answer ? 'ì™€ ' : ''}${data.answer ? 'ë‹µë³€' : ''}ì´ ì…ë ¥ í•„ë“œì— ìë™ìœ¼ë¡œ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤.
                </p>
            </div>
        `;

        setTimeout(() => {
            resultsDiv.innerHTML = '';
        }, 3000);
    }

    function getWorkflowLabel(workflow) {
        const labels = {
            'full_generation': 'ğŸ¯ ì „ì²´ ìƒì„±',
            'query_generation': 'â“ ì§ˆì˜ ìƒì„±',
            'answer_generation': 'ğŸ’¡ ë‹µë³€ ìƒì„±',
            'edit_query': 'âœï¸ ì§ˆì˜ ìˆ˜ì •',
            'edit_answer': 'âœï¸ ë‹µë³€ ìˆ˜ì •',
            'edit_both': 'âœï¸ ì§ˆì˜+ë‹µë³€ ìˆ˜ì •',
            'rewrite': 'âœ… ì¬ì‘ì„±/ê²€ìˆ˜'
        };
        return labels[workflow] || workflow;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    // í•„ë“œ ë‚´ìš© ë³µì‚¬
    function copyFieldContent(fieldId, buttonEl) {
        const field = document.getElementById(fieldId);
        const text = field.value.trim();
        if (!text) {
            showToast('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        copyToClipboard(text, buttonEl);
        showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.', 'success');
    }

    // ì „ì²´ ì„¤ëª…ë¬¸ ì°¸ì¡° ì €ì¥/ë³µì›
    const GLOBAL_EXPLANATION_KEY = 'workspace_global_explanation';
    document.addEventListener('DOMContentLoaded', () => {
        const savedRef = localStorage.getItem(GLOBAL_EXPLANATION_KEY);
        if (savedRef) {
            document.getElementById('global-explanation-ref').value = savedRef;
        }
    });

    let saveRefTimeout;
    document.getElementById('global-explanation-ref').addEventListener('input', (e) => {
        clearTimeout(saveRefTimeout);
        const value = e.target.value;
        saveRefTimeout = setTimeout(() => {
            localStorage.setItem(GLOBAL_EXPLANATION_KEY, value);
        }, 300);
    });

    document.getElementById('clear-reference-btn').addEventListener('click', () => {
        document.getElementById('global-explanation-ref').value = '';
        localStorage.removeItem(GLOBAL_EXPLANATION_KEY);
    });

    // ì„¸ì…˜ ë³µì›
    const savedQuery = sessionStorage.getItem('workspace_query');
    const savedAnswer = sessionStorage.getItem('workspace_answer');
    if (savedQuery) {
        document.getElementById('query').value = savedQuery;
        sessionStorage.removeItem('workspace_query');
    }
    if (savedAnswer) {
        document.getElementById('answer').value = savedAnswer;
        sessionStorage.removeItem('workspace_answer');
    }

    // ì´ˆê¸°í™”
    loadOCR();
    document.getElementById('save-ocr-btn').addEventListener('click', saveOCR);
</script>
{% endblock %}
