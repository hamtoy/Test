{"version":3,"file":"qa.js","sources":["../../qa.ts"],"sourcesContent":["import { apiCall, showToast, showProgressWithEstimate, withRetry } from \"./utils.js\";\nimport { loadOCR, saveOCR } from \"./ocr.js\";\nimport { validateRequest, ValidationError } from \"./validation.js\";\n\ndeclare global {\n    interface Window {\n        DOMPurify: {\n            sanitize: (text: string) => string;\n        };\n        marked: {\n            parse: (src: string, options?: Record<string, unknown>) => string;\n        };\n    }\n}\n\ninterface QAPair {\n    type: string;\n    query: string;\n    answer: string;\n}\n\ninterface QAData {\n    success?: boolean;\n    data?: {\n        pairs?: QAPair[];\n        pair?: QAPair;\n    };\n    pairs?: QAPair[]; // flatten access\n    pair?: QAPair;\n}\n\nlet activeController: AbortController | null = null;\n\nfunction getModeLabels(mode: string): { title: string; eta: string } {\n    if (mode === \"batch\") {\n        return { title: \"‚ö° 4Í∞ú ÌÉÄÏûÖ ÎèôÏãú ÏÉùÏÑ± Ï§ë...\", eta: \"30Ï¥à~2Î∂Ñ\" };\n    }\n    if (mode === \"batch_three\") {\n        return { title: \"‚ö° 3Í∞ú ÌÉÄÏûÖ ÎèôÏãú ÏÉùÏÑ± Ï§ë...\", eta: \"20Ï¥à~90Ï¥à\" };\n    }\n    return { title: \"üöÄ ÎãµÎ≥Ä ÏÉùÏÑ± Ï§ë...\", eta: \"15Ï¥à~1Î∂Ñ\" };\n}\n\nfunction renderProgress(mode: string): string {\n    const { title, eta } = getModeLabels(mode);\n    return `\n        <div class=\"progress-container\" style=\"text-align: center; padding: 40px 20px; background: var(--bg-secondary, #f5f5f5); border-radius: 8px;\">\n            <h3 style=\"margin-bottom: 20px; color: var(--text-primary, #333);\">${title}</h3>\n            <div style=\"margin: 25px auto; width: 320px; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);\">\n                <div class=\"progress-fill\" style=\"width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary, #21808d) 0%, var(--primary-dark, #1a6673) 100%); transition: width 0.5s ease;\"></div>\n            </div>\n            <p style=\"color: var(--text-secondary, #666); font-size: 0.95em; margin-top: 20px; font-weight: 500;\">ÏòàÏÉÅ ÏÜåÏöî ÏãúÍ∞Ñ: <strong>${eta}</strong></p>\n            <p style=\"color: var(--text-secondary, #666); font-size: 0.85em; margin-top: 8px;\">Î≥ëÎ†¨ Ï≤òÎ¶¨Î°ú Îπ†Î•¥Í≤å ÏôÑÎ£åÎê©ÎãàÎã§ ‚ú®</p>\n        </div>\n    `;\n}\n\nfunction escapeHtml(text: string): string {\n    const div = document.createElement(\"div\");\n    div.textContent = text || \"\";\n    return div.innerHTML;\n}\n\nfunction formatAnswer(text: string): string {\n    const raw = text || \"\";\n    // 1) ÎßàÌÅ¨Îã§Ïö¥ÏùÑ HTMLÎ°ú ÌååÏã±, 2) Sanitize, 3) ÌååÏÑúÍ∞Ä ÏóÜÏùÑ ÎïåÎäî Í∏∞Ï°¥ Îã®Ïàú Î≥ÄÌôò\n    const parsed = window.marked?.parse\n        ? window.marked.parse(raw, { breaks: true })\n        : escapeHtml(raw)\n            .replaceAll(\"\\n\\n\", \"<br><br>\")\n            .replaceAll(\"\\n\", \"<br>\")\n            .replaceAll(\" - \", \"<br><br>- \");\n    return window.DOMPurify ? window.DOMPurify.sanitize(parsed) : parsed;\n}\n\nfunction getTypeBadge(type: string): string {\n    const badges: Record<string, string> = {\n        explanation: \"üåç Ï†ÑÎ∞ò ÏÑ§Î™Ö\",\n        global_explanation: \"üåç Ï†ÑÎ∞ò ÏÑ§Î™Ö\",\n        reasoning: \"üß† Ï∂îÎ°†\",\n        target_short: \"üéØ ÌÉÄÍ≤ü Îã®Îãµ\",\n        target_long: \"üìù ÌÉÄÍ≤ü Ïû•Îãµ\",\n    };\n    return badges[type] || type;\n}\n\nfunction copyToClipboard(query: string, answer: string): void {\n    const text = `üí¨ ÏßàÏùò\\n${query}\\n\\n‚ú® ÎãµÎ≥Ä\\n${answer}`;\n    navigator.clipboard.writeText(text).then(() => {\n        showToast(\"ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.\", \"success\");\n    }).catch(() => {\n        showToast(\"Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\", \"error\");\n    });\n}\n\nfunction isQAPair(value: unknown): value is QAPair {\n    if (!value || typeof value !== \"object\") return false;\n    const candidate = value as Record<string, unknown>;\n    return (\n        typeof candidate.type === \"string\" &&\n        typeof candidate.query === \"string\" &&\n        typeof candidate.answer === \"string\"\n    );\n}\n\nfunction extractPairs(raw: unknown): QAPair[] {\n    if (!raw || typeof raw !== \"object\") return [];\n\n    const payload = raw as QAData;\n    const candidates: unknown[] = [];\n\n    if (payload.pairs) candidates.push(...payload.pairs);\n    if (payload.pair) candidates.push(payload.pair);\n    if (payload.data?.pairs) candidates.push(...payload.data.pairs);\n    if (payload.data?.pair) candidates.push(payload.data.pair);\n\n    return candidates.filter(isQAPair);\n}\n\nfunction displayResults(raw: unknown): void {\n    let pairs = extractPairs(raw);\n    const resultsDiv = document.getElementById(\"results\");\n    if (!resultsDiv) return;\n    resultsDiv.setAttribute(\"role\", \"status\");\n    resultsDiv.setAttribute(\"aria-live\", \"polite\");\n    resultsDiv.innerHTML = \"\";\n\n    const selectedMode = (document.querySelector(\"input[name=\\\"mode\\\"]:checked\") as HTMLInputElement)?.value;\n    if (selectedMode === \"batch_three\") {\n        const allowed = new Set([\"global_explanation\", \"reasoning\", \"target_long\"]);\n        pairs = pairs.filter((p) => allowed.has(p.type));\n    }\n    if (!pairs.length) {\n        const emptyCard = document.createElement(\"div\");\n        emptyCard.className = \"qa-card\";\n        const emptyText = document.createElement(\"p\");\n        emptyText.className = \"qa-empty-message\";\n        emptyText.textContent = \"Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.\";\n        emptyCard.appendChild(emptyText);\n        resultsDiv.appendChild(emptyCard);\n        return;\n    }\n\n    pairs.forEach((item, index) => {\n        const card = document.createElement(\"div\");\n        card.className = \"qa-card\";\n        card.style.animation = `slideIn 0.3s ease-out ${index * 0.05}s both`;\n\n        // Header with type badge\n        const header = document.createElement(\"div\");\n        header.className = \"qa-header\";\n        const badge = document.createElement(\"span\");\n        badge.className = \"qa-type-badge\";\n        badge.textContent = getTypeBadge(item.type);\n        header.appendChild(badge);\n        card.appendChild(header);\n\n        // Query section\n        const querySection = document.createElement(\"div\");\n        querySection.className = \"qa-section\";\n        const queryLabel = document.createElement(\"strong\");\n        queryLabel.textContent = \"üí¨ ÏßàÏùò\";\n        const queryContent = document.createElement(\"div\");\n        queryContent.className = \"qa-content\";\n        queryContent.textContent = item.query;\n        querySection.appendChild(queryLabel);\n        querySection.appendChild(queryContent);\n        card.appendChild(querySection);\n\n        // Answer section\n        const answerSection = document.createElement(\"div\");\n        answerSection.className = \"qa-section\";\n        const answerLabel = document.createElement(\"strong\");\n        answerLabel.textContent = \"‚ú® ÎãµÎ≥Ä\";\n        const answerContent = document.createElement(\"div\");\n        answerContent.className = \"qa-content\";\n        // Use innerHTML with sanitized content for answer formatting\n        answerContent.innerHTML = formatAnswer(item.answer);\n        answerSection.appendChild(answerLabel);\n        answerSection.appendChild(answerContent);\n        card.appendChild(answerSection);\n\n        // Button row\n        const btnRow = document.createElement(\"div\");\n        btnRow.className = \"btn-row qa-btn-row\";\n        const copyBtn = document.createElement(\"button\");\n        copyBtn.className = \"btn-small qa-copy-btn\";\n        copyBtn.textContent = \"üìã Î≥µÏÇ¨\";\n        copyBtn.addEventListener(\"click\", () => {\n            copyToClipboard(item.query || \"\", item.answer || \"\");\n        });\n        btnRow.appendChild(copyBtn);\n        card.appendChild(btnRow);\n\n        resultsDiv.appendChild(card);\n    });\n}\n\ntype GenerateMode = \"single\" | \"batch\" | \"batch_three\";\n\ninterface GeneratePayload {\n    mode: \"single\" | \"batch\";\n    ocr_text: string;\n    qtype?: string;\n    batch_types?: string[];\n}\n\nasync function generateQA(mode: GenerateMode, qtype: string | null): Promise<void> {\n    const resultsDiv = document.getElementById(\"results\");\n    if (!resultsDiv) return;\n    const ocrInput = document.getElementById(\"ocr-input\") as HTMLTextAreaElement;\n    const ocrText = ocrInput.value;\n\n    if (!ocrText.trim()) {\n        showToast(\"OCR ÌÖçÏä§Ìä∏Î•º Î®ºÏ†Ä ÏûÖÎ†•ÌïòÏÑ∏Ïöî.\", \"error\");\n        return;\n    }\n\n    resultsDiv.innerHTML = renderProgress(mode);\n    const stopProgress = showProgressWithEstimate(mode === \"batch\" || mode === \"batch_three\" ? \"batch\" : \"single\");\n    const progressBar = document.querySelector(\".progress-fill\") as HTMLElement;\n\n    try {\n        const payload: GeneratePayload =\n            mode === \"single\"\n                ? {\n                    mode: \"single\",\n                    ocr_text: ocrText,\n                    qtype: qtype || \"global_explanation\",\n                }\n                : {\n                    mode: \"batch\",\n                    ocr_text: ocrText,\n                };\n\n        if (mode === \"batch_three\") {\n            payload.batch_types = [\n                \"global_explanation\",\n                \"reasoning\",\n                \"target_long\",\n            ];\n        }\n\n        // Validate request payload before sending\n        try {\n            validateRequest(payload, \"/api/qa/generate\");\n        } catch (validationError) {\n            if (validationError instanceof ValidationError) {\n                showToast(`ÏöîÏ≤≠ Í≤ÄÏ¶ù Ïã§Ìå®: ${validationError.message}`, \"error\");\n                stopProgress();\n                resultsDiv.innerHTML = `\n                    <div style=\"text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;\">\n                        <h3 style=\"color: #f44336; margin-bottom: 10px;\">‚ö†Ô∏è ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ Ïò§Î•ò</h3>\n                        <p style=\"color: #666; margin: 0; white-space: pre-line;\">${validationError.message}</p>\n                        <p style=\"color: #999; margin-top: 15px; font-size: 0.9em;\">üí° ÌïÑÎìúÎ™ÖÍ≥º Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>\n                    </div>\n                `;\n                return;\n            }\n            throw validationError;\n        }\n\n        if (activeController) {\n            activeController.abort();\n        }\n        activeController = new AbortController();\n        const result = await withRetry(\n            () => apiCall<QAData>(\"/api/qa/generate\", \"POST\", payload, activeController!.signal),\n            2,\n            800,\n        );\n        activeController = null;\n        stopProgress();\n        if (progressBar) progressBar.style.width = \"100%\";\n        await new Promise((resolve) => setTimeout(resolve, 300));\n        displayResults(result);\n    } catch (error: unknown) {\n        activeController = null;\n        stopProgress();\n        const message =\n            error instanceof Error ? error.message : \"Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\";\n        resultsDiv.innerHTML = `\n            <div style=\"text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;\">\n                <h3 style=\"color: #f44336; margin-bottom: 10px;\">‚ùå ÏÉùÏÑ± Ïã§Ìå®</h3>\n                <p style=\"color: #666; margin: 0;\">${message}</p>\n            </div>\n        `;\n    }\n}\n\n// Streaming helpers\nfunction createSkeletonCard(type: string): HTMLElement {\n    const card = document.createElement(\"div\");\n    card.className = \"qa-card\";\n    card.id = `qa-card-${type}`;\n    card.setAttribute(\"aria-busy\", \"true\");\n    const badge = document.createElement(\"div\");\n    badge.className = \"qa-type-badge\";\n    badge.textContent = getTypeBadge(type);\n    card.appendChild(badge);\n    const skeletonQuery = document.createElement(\"div\");\n    skeletonQuery.className = \"skeleton skeleton-text\";\n    skeletonQuery.style.cssText = \"height: 1.5em; width: 80%; margin: 16px 0\";\n    card.appendChild(skeletonQuery);\n    const skeletonAnswer = document.createElement(\"div\");\n    skeletonAnswer.className = \"skeleton skeleton-block\";\n    skeletonAnswer.style.cssText = \"height: 100px; margin: 16px 0\";\n    card.appendChild(skeletonAnswer);\n    return card;\n}\n\nfunction updateCardWithData(type: string, data: QAPair): void {\n    const card = document.getElementById(`qa-card-${type}`);\n    if (!card) return;\n    card.removeAttribute(\"aria-busy\");\n    card.innerHTML = \"\";\n    const badge = document.createElement(\"div\");\n    badge.className = \"qa-type-badge\";\n    badge.textContent = getTypeBadge(type);\n    card.appendChild(badge);\n    const querySection = document.createElement(\"div\");\n    querySection.className = \"qa-section\";\n    const queryLabel = document.createElement(\"strong\");\n    queryLabel.textContent = \"üí¨ ÏßàÏùò\";\n    const queryContent = document.createElement(\"div\");\n    queryContent.className = \"qa-content\";\n    queryContent.textContent = data.query;\n    querySection.appendChild(queryLabel);\n    querySection.appendChild(queryContent);\n    card.appendChild(querySection);\n    const answerSection = document.createElement(\"div\");\n    answerSection.className = \"qa-section\";\n    const answerLabel = document.createElement(\"strong\");\n    answerLabel.textContent = \"‚ú® ÎãµÎ≥Ä\";\n    const answerContent = document.createElement(\"div\");\n    answerContent.className = \"qa-content\";\n    answerContent.innerHTML = formatAnswer(data.answer);\n    answerSection.appendChild(answerLabel);\n    answerSection.appendChild(answerContent);\n    card.appendChild(answerSection);\n    const btnRow = document.createElement(\"div\");\n    btnRow.className = \"btn-row qa-btn-row\";\n    const copyBtn = document.createElement(\"button\");\n    copyBtn.className = \"btn-small qa-copy-btn\";\n    copyBtn.textContent = \"üìã Î≥µÏÇ¨\";\n    copyBtn.addEventListener(\"click\", () => copyToClipboard(data.query, data.answer));\n    btnRow.appendChild(copyBtn);\n    card.appendChild(btnRow);\n}\n\nfunction showErrorInCard(type: string, error: string): void {\n    const card = document.getElementById(`qa-card-${type}`);\n    if (!card) return;\n    card.removeAttribute(\"aria-busy\");\n    card.innerHTML = \"\";\n    card.className = \"qa-card error-state\";\n    card.setAttribute(\"role\", \"alert\");\n    const icon = document.createElement(\"div\");\n    icon.className = \"error-state__icon\";\n    icon.textContent = \"‚ö†Ô∏è\";\n    card.appendChild(icon);\n    const heading = document.createElement(\"h3\");\n    heading.style.cssText = \"margin: 0 0 8px 0; color: var(--accent-danger);\";\n    heading.textContent = `${getTypeBadge(type)} ÏÉùÏÑ± Ïã§Ìå®`;\n    card.appendChild(heading);\n    const text = document.createElement(\"p\");\n    text.className = \"error-state__text\";\n    text.textContent = error;\n    card.appendChild(text);\n}\n\nexport async function generateQAStreaming(mode: \"batch\" | \"batch_three\"): Promise<void> {\n    const resultsDiv = document.getElementById(\"results\");\n    if (!resultsDiv) return;\n    const ocrInput = document.getElementById(\"ocr-input\") as HTMLTextAreaElement;\n    const ocrText = ocrInput.value;\n    if (!ocrText.trim()) {\n        showToast(\"OCR ÌÖçÏä§Ìä∏Î•º Î®ºÏ†Ä ÏûÖÎ†•ÌïòÏÑ∏Ïöî.\", \"error\");\n        return;\n    }\n    resultsDiv.innerHTML = \"\";\n\n    // Ï¶âÏãú skeleton Ïπ¥Îìú ÌëúÏãú (ÏÑúÎ≤Ñ ÏùëÎãµ Ï†ÑÏóê Î°úÎî© ÌîºÎìúÎ∞± Ï†úÍ≥µ)\n    const immediateTypes = mode === \"batch_three\"\n        ? [\"global_explanation\", \"reasoning\", \"target_long\"]\n        : [\"global_explanation\", \"reasoning\", \"target_short\", \"target_long\"];\n    immediateTypes.forEach(type => resultsDiv.appendChild(createSkeletonCard(type)));\n\n    try {\n        const response = await fetch(\"/api/qa/generate/batch/stream\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ mode, ocr_text: ocrText }),\n            signal: activeController?.signal\n        });\n        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n        if (!response.body) throw new Error(\"No response body\");\n        const reader = response.body.getReader();\n        const decoder = new TextDecoder();\n        let buffer = \"\";\n        while (true) {\n            const { done, value } = await reader.read();\n            if (done) break;\n            buffer += decoder.decode(value, { stream: true });\n            const events = buffer.split(\"\\n\\n\");\n            buffer = events.pop() || \"\";\n            for (const event of events) {\n                if (!event.startsWith(\"data: \")) continue;\n                const payload = event.slice(6).trim();\n                try {\n                    const data = JSON.parse(payload);\n                    if (data.event === \"started\") {\n                        // skeletonÏùÄ Ïù¥ÎØ∏ fetch Ï†ÑÏóê ÌëúÏãúÎê®, skip\n                    } else if (data.event === \"progress\") {\n                        updateCardWithData(data.type, data.data);\n                    } else if (data.event === \"error\") {\n                        if (data.type) showErrorInCard(data.type, data.error);\n                        else showToast(`Ïò§Î•ò: ${data.error}`, \"error\");\n                    } else if (data.event === \"done\") {\n                        const summary = data.success ? `‚úÖ ÏôÑÎ£å: ${data.completed}/${data.total} ÏÑ±Í≥µ` : \"‚ö†Ô∏è ÏùºÎ∂Ä Ïã§Ìå®\";\n                        showToast(summary, data.success ? \"success\" : \"warning\");\n                    }\n                } catch (parseError) {\n                    console.error(\"Failed to parse SSE event:\", payload, parseError);\n                }\n            }\n        }\n    } catch (error) {\n        console.error(\"Streaming error:\", error);\n        const message = error instanceof Error ? error.message : \"Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò\";\n        resultsDiv.innerHTML = `<div class=\"error-state\"><div class=\"error-state__icon\">‚ö†Ô∏è</div><h3 style=\"margin: 0 0 8px 0; color: var(--accent-danger);\">Ïä§Ìä∏Î¶¨Î∞ç Ïã§Ìå®</h3><p class=\"error-state__text\">${message}</p></div>`;\n        showToast(`Ïä§Ìä∏Î¶¨Î∞ç Ïò§Î•ò: ${message}`, \"error\");\n    }\n}\n\nfunction setupModeKeyboardNavigation(): void {\n    const radios = Array.from(document.querySelectorAll<HTMLInputElement>(\"input[name=\\\"mode\\\"]\"));\n    if (!radios.length) return;\n\n    const focusRadio = (index: number) => {\n        const target = radios[index];\n        target.focus();\n        target.checked = true;\n        target.dispatchEvent(new Event(\"change\", { bubbles: true }));\n    };\n\n    radios.forEach((radio, idx) => {\n        radio.addEventListener(\"keydown\", (e: KeyboardEvent) => {\n            let nextIndex = idx;\n            if (e.key === \"ArrowRight\" || e.key === \"ArrowDown\") {\n                nextIndex = (idx + 1) % radios.length;\n                e.preventDefault();\n                focusRadio(nextIndex);\n            } else if (e.key === \"ArrowLeft\" || e.key === \"ArrowUp\") {\n                nextIndex = (idx - 1 + radios.length) % radios.length;\n                e.preventDefault();\n                focusRadio(nextIndex);\n            } else if (e.key === \"Home\") {\n                e.preventDefault();\n                focusRadio(0);\n            } else if (e.key === \"End\") {\n                e.preventDefault();\n                focusRadio(radios.length - 1);\n            }\n        });\n    });\n}\n\nexport function initQA(): void {\n    loadOCR();\n    document.getElementById(\"save-ocr-btn\")?.addEventListener(\"click\", () => saveOCR());\n\n    document.querySelectorAll(\"input[name=\\\"mode\\\"]\").forEach((radio) => {\n        radio.addEventListener(\"change\", (e) => {\n            const selector = document.getElementById(\"type-selector\");\n            if (selector) {\n                selector.style.display = (e.target as HTMLInputElement).value === \"single\" ? \"block\" : \"none\";\n            }\n        });\n    });\n\n    document.getElementById(\"generate-btn\")?.addEventListener(\"click\", async () => {\n        const modeInput = document.querySelector(\"input[name=\\\"mode\\\"]:checked\") as HTMLInputElement;\n        const mode = (modeInput?.value || \"single\") as GenerateMode;\n        const qtypeInput = document.getElementById(\"qtype\") as HTMLSelectElement;\n        const qtype = mode === \"single\" ? qtypeInput.value : null;\n        if (mode === \"batch\" || mode === \"batch_three\") {\n            await generateQAStreaming(mode);\n        } else {\n            await generateQA(mode, qtype);\n        }\n    });\n\n    setupModeKeyboardNavigation();\n\n    document.addEventListener(\"keydown\", (e) => {\n        if (e.key === \"Escape\" && activeController) {\n            activeController.abort();\n            showToast(\"ÏöîÏ≤≠ÏùÑ Ï∑®ÏÜåÌñàÏäµÎãàÎã§.\", \"warning\");\n        }\n    });\n}\n"],"names":["activeController","getModeLabels","mode","renderProgress","title","eta","escapeHtml","text","div","formatAnswer","raw","parsed","_a","getTypeBadge","type","copyToClipboard","query","answer","showToast","isQAPair","value","candidate","extractPairs","payload","candidates","_b","displayResults","pairs","resultsDiv","allowed","p","emptyCard","emptyText","item","index","card","header","badge","querySection","queryLabel","queryContent","answerSection","answerLabel","answerContent","btnRow","copyBtn","generateQA","qtype","ocrText","stopProgress","showProgressWithEstimate","progressBar","validateRequest","validationError","ValidationError","result","withRetry","apiCall","resolve","error","message","createSkeletonCard","skeletonQuery","skeletonAnswer","updateCardWithData","data","showErrorInCard","icon","heading","generateQAStreaming","response","reader","decoder","buffer","done","events","event","summary","parseError","setupModeKeyboardNavigation","radios","focusRadio","target","radio","idx","e","nextIndex","initQA","loadOCR","saveOCR","selector","modeInput","qtypeInput"],"mappings":"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"}