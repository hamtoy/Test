{% extends "layout.html" %}

{% block content %}
<div class="split-layout">
    <!-- ì™¼ìª½: OCR ì˜ì—­ -->
    <div class="left-panel">
        <h2>ğŸ“„ OCR í…ìŠ¤íŠ¸</h2>
        <textarea id="ocr-input" class="ocr-box" rows="20" placeholder="OCR í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        <div class="btn-row">
            <button id="save-ocr-btn" class="btn-primary" style="width: 100%;">ğŸ’¾ ì €ì¥</button>
        </div>
        <span id="ocr-save-status" class="status-text"></span>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì›Œí¬ìŠ¤í˜ì´ìŠ¤ -->
    <div class="right-panel">
        <h2>ğŸ”¥ ì›Œí¬ìŠ¤í˜ì´ìŠ¤</h2>
        
        <!-- ì‘ì—… ëª¨ë“œ ì„ íƒ (íƒ­ ìŠ¤íƒ€ì¼) -->
        <div class="mode-tabs">
            <button class="mode-tab active" data-mode="generate-answer">ğŸ’¡ ë‹µë³€ ìƒì„±</button>
            <button class="mode-tab" data-mode="generate-query">â“ ì§ˆë¬¸ ìƒì„±</button>
            <button class="mode-tab" data-mode="inspect">âœ… ê²€ìˆ˜</button>
            <button class="mode-tab" data-mode="edit">âœï¸ ììœ  ìˆ˜ì •</button>
        </div>

        <!-- ì§ˆì˜ ì…ë ¥ -->
        <div class="form-group">
            <label id="query-label">ì§ˆì˜</label>
            <textarea id="query" rows="3" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>

        <!-- ë‹µë³€ ì…ë ¥ -->
        <div class="form-group">
            <label id="answer-label">ë‹µë³€</label>
            <textarea id="answer" rows="8" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>

        <!-- ììœ  ìˆ˜ì •ìš© ì…ë ¥ (edit ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) -->
        <div id="edit-request-box" class="form-group" style="display: none;">
            <label>ìˆ˜ì • ìš”ì²­</label>
            <input type="text" id="edit-request" placeholder="ì˜ˆ: ë” ê°„ê²°í•˜ê²Œ, ìˆ«ì ê°•ì¡°, ë¬¸ì¥ ë‹¤ë“¬ê¸°...">
        </div>

        <!-- ì‹¤í–‰ ë²„íŠ¼ -->
        <button id="execute-btn" class="btn-primary" style="width: 100%;">â–¶ï¸ ì‹¤í–‰</button>

        <!-- ê²°ê³¼ ì˜ì—­ -->
        <div id="workspace-results" class="results-area"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // OCR ë¡œë“œ/ì €ì¥
    async function loadOCR() {
        try {
            const data = await apiCall('/api/ocr');
            document.getElementById('ocr-input').value = data.ocr || '';
        } catch (error) {
            document.getElementById('ocr-input').placeholder = 'OCR ë¡œë“œ ì‹¤íŒ¨';
        }
    }

    async function saveOCR() {
        const text = document.getElementById('ocr-input').value;
        const statusEl = document.getElementById('ocr-save-status');
        try {
            await apiCall('/api/ocr', 'POST', { text });
            statusEl.textContent = 'âœ… ì €ì¥ë¨';
            statusEl.className = 'status-text success';
            setTimeout(() => statusEl.textContent = '', 2000);
        } catch (error) {
            statusEl.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨';
            statusEl.className = 'status-text error';
        }
    }

    // í˜„ì¬ ëª¨ë“œ
    let currentMode = 'generate-answer';

    // ëª¨ë“œ íƒ­ ì „í™˜
    document.querySelectorAll('.mode-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentMode = tab.dataset.mode;
            updateUIForMode();
        });
    });

    function updateUIForMode() {
        const queryLabel = document.getElementById('query-label');
        const answerLabel = document.getElementById('answer-label');
        const queryInput = document.getElementById('query');
        const answerInput = document.getElementById('answer');
        const editBox = document.getElementById('edit-request-box');

        editBox.style.display = 'none';

        switch(currentMode) {
            case 'generate-answer':
                queryLabel.textContent = 'ì§ˆì˜ (í•„ìˆ˜)';
                answerLabel.textContent = 'ë‹µë³€ (ìë™ ìƒì„±ë¨)';
                queryInput.placeholder = 'ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ OCR ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤...';
                answerInput.placeholder = 'ìƒì„±ëœ ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...';
                break;
            case 'generate-query':
                queryLabel.textContent = 'ì§ˆì˜ (ìë™ ìƒì„±ë¨)';
                answerLabel.textContent = 'ë‹µë³€ (í•„ìˆ˜)';
                queryInput.placeholder = 'ìƒì„±ëœ ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...';
                answerInput.placeholder = 'ë‹µë³€ì„ ì…ë ¥í•˜ë©´ ì ì ˆí•œ ì§ˆë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤...';
                break;
            case 'inspect':
                queryLabel.textContent = 'ì§ˆì˜ (ì„ íƒ)';
                answerLabel.textContent = 'ë‹µë³€ (í•„ìˆ˜)';
                queryInput.placeholder = 'ì§ˆì˜ê°€ ìˆìœ¼ë©´ ë” ì •í™•í•œ ê²€ìˆ˜ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤...';
                answerInput.placeholder = 'ê²€ìˆ˜í•  ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...';
                break;
            case 'edit':
                queryLabel.textContent = 'ì§ˆì˜ (ì„ íƒ)';
                answerLabel.textContent = 'ë‹µë³€ (í•„ìˆ˜)';
                queryInput.placeholder = 'ì›ë³¸ ì§ˆì˜ (ì„ íƒ)';
                answerInput.placeholder = 'ìˆ˜ì •í•  ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...';
                editBox.style.display = 'block';
                break;
        }
    }

    // ì‹¤í–‰
    document.getElementById('execute-btn').addEventListener('click', async () => {
        const query = document.getElementById('query').value;
        const answer = document.getElementById('answer').value;
        const editRequest = document.getElementById('edit-request').value;
        const ocrText = document.getElementById('ocr-input').value;

        // ìœ íš¨ì„± ê²€ì‚¬
        if (currentMode === 'generate-answer' && !query.trim()) {
            alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        if (currentMode === 'generate-query' && !answer.trim()) {
            alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        if ((currentMode === 'inspect' || currentMode === 'edit') && !answer.trim()) {
            alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        if (currentMode === 'edit' && !editRequest.trim()) {
            alert('ìˆ˜ì • ìš”ì²­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        showLoading('workspace-results');

        try {
            let result;

            if (currentMode === 'generate-answer') {
                result = await apiCall('/api/workspace/generate-answer', 'POST', { query, ocr_text: ocrText });
                document.getElementById('answer').value = result.answer;
            } else if (currentMode === 'generate-query') {
                result = await apiCall('/api/workspace/generate-query', 'POST', { answer, ocr_text: ocrText });
                document.getElementById('query').value = result.query;
            } else {
                const body = { mode: currentMode, query, answer };
                if (currentMode === 'edit') body.edit_request = editRequest;
                result = await apiCall('/api/workspace', 'POST', body);
            }

            displayResult(result);
        } catch (error) {
            document.getElementById('workspace-results').innerHTML = 
                `<p style="color: var(--danger)">ì‘ì—… ì‹¤íŒ¨: ${error.message}</p>`;
        }
    });

    function displayResult(data) {
        const resultsDiv = document.getElementById('workspace-results');
        resultsDiv.innerHTML = '<h3>âœ¨ ê²°ê³¼</h3>';

        const card = document.createElement('div');
        card.className = 'result-card';

        const pre = document.createElement('pre');
        // Response format varies by mode:
        // - generate-answer/query: {answer: "...", query: "..."}
        // - inspect: {result: {fixed: "..."}}
        // - edit: {result: {edited: "..."}}
        pre.textContent = data.answer || data.query || data.result?.fixed || data.result?.edited || 'ê²°ê³¼ ì—†ìŒ';

        const btnRow = document.createElement('div');
        btnRow.className = 'btn-row';

        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn-secondary';
        copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
        copyBtn.addEventListener('click', () => copyToClipboard(pre.textContent));

        const applyBtn = document.createElement('button');
        applyBtn.className = 'btn-secondary';
        applyBtn.textContent = 'âœ… ì ìš©';
        applyBtn.addEventListener('click', () => {
            if (data.answer) document.getElementById('answer').value = data.answer;
            if (data.query) document.getElementById('query').value = data.query;
            if (data.result?.fixed) document.getElementById('answer').value = data.result.fixed;
            if (data.result?.edited) document.getElementById('answer').value = data.result.edited;
        });

        btnRow.appendChild(copyBtn);
        btnRow.appendChild(applyBtn);
        card.appendChild(pre);
        card.appendChild(btnRow);
        resultsDiv.appendChild(card);
    }

    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë³µì›
    const savedQuery = sessionStorage.getItem('workspace_query');
    const savedAnswer = sessionStorage.getItem('workspace_answer');
    if (savedQuery) {
        document.getElementById('query').value = savedQuery;
        sessionStorage.removeItem('workspace_query');
    }
    if (savedAnswer) {
        document.getElementById('answer').value = savedAnswer;
        sessionStorage.removeItem('workspace_answer');
    }

    // ì´ˆê¸°í™”
    loadOCR();
    document.getElementById('save-ocr-btn').addEventListener('click', saveOCR);
    updateUIForMode();
</script>
{% endblock %}
