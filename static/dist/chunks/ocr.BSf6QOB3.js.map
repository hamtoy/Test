{"version":3,"file":"ocr.BSf6QOB3.js","sources":["../../ocr.ts"],"sourcesContent":["import { apiCall, showToast } from \"./utils.js\";\n\ninterface OcrResponse {\n    ocr?: string;\n}\n\ninterface ImageOcrResponse {\n    status: string;\n    ocr: string;\n    metadata: {\n        text_density: number;\n        topics: string[];\n        has_table_chart: boolean;\n    };\n}\n\nexport async function loadOCR(targetId: string = \"ocr-input\"): Promise<void> {\n    const input =\n        document.getElementById(targetId) ||\n        document.getElementById(\"ocr-preview\");\n    if (!input) {\n        console.error(\"OCR element not found\");\n        return;\n    }\n    try {\n        const data = await apiCall<OcrResponse>(\"/api/ocr\");\n        const value = data.ocr || \"\";\n        if (input.tagName === \"TEXTAREA\") {\n            (input as HTMLTextAreaElement).value = value;\n            if (!value) {\n                (input as HTMLTextAreaElement).placeholder = \"OCR ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§. ÌÖçÏä§Ìä∏Î•º ÏßÅÏ†ë ÏûÖÎ†•ÌïòÍ±∞ÎÇò Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî...\";\n            }\n        } else {\n            input.textContent = value || \"OCR ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.\";\n            if (!value) input.style.color = \"#999\";\n        }\n    } catch (error: unknown) {\n        const errorMessage = error instanceof Error ? error.message : \"OCR Î°úÎìú Ïã§Ìå®\";\n        if (input.tagName === \"TEXTAREA\") {\n            (input as HTMLTextAreaElement).value = \"\";\n            (input as HTMLTextAreaElement).placeholder = errorMessage;\n        } else {\n            input.textContent = errorMessage;\n        }\n        showToast(`OCR Î°úÎìú Ïã§Ìå®: ${errorMessage}`, \"error\");\n    }\n}\n\nexport async function saveOCR(sourceId: string = \"ocr-input\", statusId: string = \"ocr-save-status\"): Promise<void> {\n    const input = document.getElementById(sourceId) as HTMLTextAreaElement;\n    if (!input) {\n        console.error(\"OCR source not found\");\n        return;\n    }\n    const statusEl = document.getElementById(statusId);\n    try {\n        await apiCall(\"/api/ocr\", \"POST\", { text: input.value });\n        if (statusEl) {\n            statusEl.textContent = \"‚úÖ Ï†ÄÏû•Îê®\";\n            statusEl.className = \"status-text success\";\n            setTimeout(() => (statusEl.textContent = \"\"), 2000);\n        }\n    } catch (error: unknown) {\n        if (statusEl) {\n            statusEl.textContent = \"‚ùå Ï†ÄÏû• Ïã§Ìå®\";\n            statusEl.className = \"status-text error\";\n        } else {\n            const message =\n                error instanceof Error ? error.message : \"Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\";\n            showToast(\"OCR Ï†ÄÏû• Ïã§Ìå®: \" + message, \"error\");\n        }\n    }\n}\n\n/** Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùÑ Gemini Vision OCRÎ°ú Ï≤òÎ¶¨ */\nexport async function uploadImageOCR(file: File): Promise<ImageOcrResponse | null> {\n    const formData = new FormData();\n    formData.append(\"file\", file);\n\n    try {\n        const response = await fetch(\"/api/ocr/image\", {\n            method: \"POST\",\n            body: formData,\n        });\n\n        if (!response.ok) {\n            const error = await response.json();\n            throw new Error(error.detail || \"OCR Ï≤òÎ¶¨ Ïã§Ìå®\");\n        }\n\n        return await response.json();\n    } catch (error) {\n        const message = error instanceof Error ? error.message : \"Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò\";\n        showToast(`Ïù¥ÎØ∏ÏßÄ OCR Ïã§Ìå®: ${message}`, \"error\");\n        return null;\n    }\n}\n\n/** ÎìúÎûòÍ∑∏Ïï§ÎìúÎ°≠ ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî */\nexport function initImageDropZone(\n    dropZoneId: string = \"image-drop-zone\",\n    targetId: string = \"ocr-input\"\n): void {\n    const dropZone = document.getElementById(dropZoneId);\n    const targetInput = document.getElementById(targetId) as HTMLTextAreaElement;\n    const fileInput = document.getElementById(\"image-file-input\") as HTMLInputElement;\n\n    if (!dropZone || !targetInput) return;\n\n    // ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏\n    dropZone.addEventListener(\"dragover\", (e) => {\n        e.preventDefault();\n        dropZone.classList.add(\"drag-over\");\n    });\n\n    dropZone.addEventListener(\"dragleave\", () => {\n        dropZone.classList.remove(\"drag-over\");\n    });\n\n    dropZone.addEventListener(\"drop\", async (e) => {\n        e.preventDefault();\n        dropZone.classList.remove(\"drag-over\");\n\n        const files = e.dataTransfer?.files;\n        if (files && files.length > 0) {\n            await processImageFile(files[0], targetInput, dropZone);\n        }\n    });\n\n    // ÌÅ¥Î¶≠ÏúºÎ°ú ÌååÏùº ÏÑ†ÌÉù\n    dropZone.addEventListener(\"click\", () => {\n        fileInput?.click();\n    });\n\n    fileInput?.addEventListener(\"change\", async () => {\n        if (fileInput.files && fileInput.files.length > 0) {\n            await processImageFile(fileInput.files[0], targetInput, dropZone);\n        }\n    });\n}\n\nasync function processImageFile(\n    file: File,\n    targetInput: HTMLTextAreaElement,\n    dropZone: HTMLElement\n): Promise<void> {\n    // Ïù¥ÎØ∏ÏßÄ ÌÉÄÏûÖ Í≤ÄÏ¶ù\n    const allowedTypes = [\"image/png\", \"image/jpeg\", \"image/gif\", \"image/webp\", \"image/bmp\"];\n    if (!allowedTypes.includes(file.type)) {\n        showToast(\"ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Ïù¥ÎØ∏ÏßÄ ÌòïÏãùÏûÖÎãàÎã§\", \"error\");\n        return;\n    }\n\n    // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú\n    const originalText = dropZone.innerHTML;\n    dropZone.innerHTML = `\n        <div class=\"ocr-loading\">\n            <div class=\"spinner\"></div>\n            <span>üîç Gemini Vision OCR Ï≤òÎ¶¨ Ï§ë...</span>\n        </div>\n    `;\n    dropZone.classList.add(\"processing\");\n\n    try {\n        const result = await uploadImageOCR(file);\n        if (result && result.ocr) {\n            targetInput.value = result.ocr;\n            showToast(`‚úÖ OCR ÏôÑÎ£å! ${result.ocr.length}Ïûê Ï∂îÏ∂ú`, \"success\");\n\n            // Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÌëúÏãú\n            if (result.metadata.topics.length > 0) {\n                console.log(\"Ï∂îÏ∂úÎêú Ï£ºÏ†ú:\", result.metadata.topics);\n            }\n            if (result.metadata.has_table_chart) {\n                showToast(\"üìä Ìëú/Ï∞®Ìä∏Í∞Ä Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§\", \"info\");\n            }\n        }\n    } finally {\n        dropZone.innerHTML = originalText;\n        dropZone.classList.remove(\"processing\");\n    }\n}\n"],"names":["loadOCR","targetId","input","value","apiCall","error","errorMessage","showToast","saveOCR","sourceId","statusId","statusEl","message","uploadImageOCR","file","formData","response","initImageDropZone","dropZoneId","dropZone","targetInput","fileInput","e","files","processImageFile","originalText","result"],"mappings":"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"}