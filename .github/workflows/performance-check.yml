name: Performance

on:
  pull_request:
    paths:
      - "src/**"
      - "tests/**"

permissions:
  contents: read

jobs:
  profile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install memory-profiler

      - name: Run profiling
        run: |
          python scripts/auto_profile.py src.main \
            --mode AUTO \
            --ocr-file examples/sample_ocr.txt \
            --output profiling_results/pr_${{ github.event.pull_request.number }}.prof

      - name: Compare with baseline
        run: |
          if [ -f profiling_results/baseline.prof ]; then
            python scripts/compare_profiles.py \
              profiling_results/baseline.prof \
              profiling_results/pr_${{ github.event.pull_request.number }}.prof
          else
            echo "No baseline found, skipping comparison"
          fi

      - name: Upload results
        uses: actions/upload-artifact@v5
        with:
          name: profile-results
          path: profiling_results/
