import{s as m,a as w,w as C,b as q}from"./utils.NDa8fJII.js";import{l as k,i as T,s as _}from"./ocr.BSf6QOB3.js";import{validateRequest as N,ValidationError as L}from"./validation.DRcAY0lR.js";let u=null;function A(n){return n==="batch"?{title:"âš¡ 4ê°œ íƒ€ì… ë™ì‹œ ìƒì„± ì¤‘...",eta:"30ì´ˆ~2ë¶„"}:n==="batch_three"?{title:"âš¡ 3ê°œ íƒ€ì… ë™ì‹œ ìƒì„± ì¤‘...",eta:"20ì´ˆ~90ì´ˆ"}:{title:"ğŸš€ ë‹µë³€ ìƒì„± ì¤‘...",eta:"15ì´ˆ~1ë¶„"}}function I(n){const{title:e,eta:t}=A(n);return`
        <div class="progress-container" style="text-align: center; padding: 40px 20px; background: var(--bg-secondary, #f5f5f5); border-radius: 8px;">
            <h3 style="margin-bottom: 20px; color: var(--text-primary, #333);">${e}</h3>
            <div style="margin: 25px auto; width: 320px; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                <div class="progress-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary, #21808d) 0%, var(--primary-dark, #1a6673) 100%); transition: width 0.5s ease;"></div>
            </div>
            <p style="color: var(--text-secondary, #666); font-size: 0.95em; margin-top: 20px; font-weight: 500;">ì˜ˆìƒ ì†Œìš” ì‹œê°„: <strong>${t}</strong></p>
            <p style="color: var(--text-secondary, #666); font-size: 0.85em; margin-top: 8px;">ë³‘ë ¬ ì²˜ë¦¬ë¡œ ë¹ ë¥´ê²Œ ì™„ë£Œë©ë‹ˆë‹¤ âœ¨</p>
        </div>
    `}function S(n){const e=document.createElement("div");return e.textContent=n||"",e.innerHTML}function x(n){const t=S(n||"").replaceAll(`

`,"<br><br>").replaceAll(`
`,"<br>");return window.DOMPurify?window.DOMPurify.sanitize(t):t}function v(n){return{explanation:"ğŸŒ ì „ë°˜ ì„¤ëª…",global_explanation:"ğŸŒ ì „ë°˜ ì„¤ëª…",reasoning:"ğŸ§  ì¶”ë¡ ",target_short:"ğŸ¯ íƒ€ê²Ÿ ë‹¨ë‹µ",target_long:"ğŸ“ íƒ€ê²Ÿ ì¥ë‹µ"}[n]||n}function E(n,e){const t=`ğŸ’¬ ì§ˆì˜
${n}

âœ¨ ë‹µë³€
${e}`;navigator.clipboard.writeText(t).then(()=>{m("í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.","success")}).catch(()=>{m("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.","error")})}function $(n){if(!n||typeof n!="object")return!1;const e=n;return typeof e.type=="string"&&typeof e.query=="string"&&typeof e.answer=="string"}function M(n){if(!n||typeof n!="object")return[];const e=n,t=[];return e.pairs&&t.push(...e.pairs),e.pair&&t.push(e.pair),e.data?.pairs&&t.push(...e.data.pairs),e.data?.pair&&t.push(e.data.pair),t.filter($)}function B(n){let e=M(n);const t=document.getElementById("results");if(!t)return;if(t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.innerHTML="",document.querySelector('input[name="mode"]:checked')?.value==="batch_three"){const r=new Set(["global_explanation","reasoning","target_long"]);e=e.filter(a=>r.has(a.type))}if(!e.length){const r=document.createElement("div");r.className="qa-card";const a=document.createElement("p");a.className="qa-empty-message",a.textContent="ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.",r.appendChild(a),t.appendChild(r);return}e.forEach((r,a)=>{const c=document.createElement("div");c.className="qa-card",c.style.animation=`slideIn 0.3s ease-out ${a*.05}s both`;const i=document.createElement("div");i.className="qa-header";const d=document.createElement("span");d.className="qa-type-badge",d.textContent=v(r.type),i.appendChild(d),c.appendChild(i);const l=document.createElement("div");l.className="qa-section";const g=document.createElement("strong");g.textContent="ğŸ’¬ ì§ˆì˜";const p=document.createElement("div");p.className="qa-content",p.textContent=r.query,l.appendChild(g),l.appendChild(p),c.appendChild(l);const h=document.createElement("div");h.className="qa-section";const y=document.createElement("strong");y.textContent="âœ¨ ë‹µë³€";const s=document.createElement("div");s.className="qa-content",s.innerHTML=x(r.answer),h.appendChild(y),h.appendChild(s),c.appendChild(h);const f=document.createElement("div");f.className="btn-row qa-btn-row";const b=document.createElement("button");b.className="btn-small qa-copy-btn",b.textContent="ğŸ“‹ ë³µì‚¬",b.addEventListener("click",()=>{E(r.query||"",r.answer||"")}),f.appendChild(b),c.appendChild(f),t.appendChild(c)})}async function H(n,e){const t=document.getElementById("results");if(!t)return;const r=document.getElementById("ocr-input").value;if(!r.trim()){m("OCR í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.","error");return}t.innerHTML=I(n);const a=w(n==="batch"||n==="batch_three"?"batch":"single"),c=document.querySelector(".progress-fill");try{const i=n==="single"?{mode:"single",ocr_text:r,qtype:e||"global_explanation"}:{mode:"batch",ocr_text:r};n==="batch_three"&&(i.batch_types=["global_explanation","reasoning","target_long"]);try{N(i,"/api/qa/generate")}catch(l){if(l instanceof L){m(`ìš”ì²­ ê²€ì¦ ì‹¤íŒ¨: ${l.message}`,"error"),a(),t.innerHTML=`
                    <div style="text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;">
                        <h3 style="color: #f44336; margin-bottom: 10px;">âš ï¸ ìš”ì²­ ë°ì´í„° ì˜¤ë¥˜</h3>
                        <p style="color: #666; margin: 0; white-space: pre-line;">${l.message}</p>
                        <p style="color: #999; margin-top: 15px; font-size: 0.9em;">ğŸ’¡ í•„ë“œëª…ê³¼ ë°ì´í„° íƒ€ì…ì„ í™•ì¸í•˜ì„¸ìš”</p>
                    </div>
                `;return}throw l}u&&u.abort(),u=new AbortController;const d=await C(()=>q("/api/qa/generate","POST",i,u.signal),2,800);u=null,a(),c&&(c.style.width="100%"),await new Promise(l=>setTimeout(l,300)),B(d)}catch(i){u=null,a();const d=i instanceof Error?i.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";t.innerHTML=`
            <div style="text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;">
                <h3 style="color: #f44336; margin-bottom: 10px;">âŒ ìƒì„± ì‹¤íŒ¨</h3>
                <p style="color: #666; margin: 0;">${d}</p>
            </div>
        `}}function D(n){const e=document.createElement("div");e.className="qa-card",e.id=`qa-card-${n}`,e.setAttribute("aria-busy","true");const t=document.createElement("div");t.className="qa-type-badge",t.textContent=v(n),e.appendChild(t);const o=document.createElement("div");o.className="skeleton skeleton-text",o.style.cssText="height: 1.5em; width: 80%; margin: 16px 0",e.appendChild(o);const r=document.createElement("div");return r.className="skeleton skeleton-block",r.style.cssText="height: 100px; margin: 16px 0",e.appendChild(r),e}function R(n,e){const t=document.getElementById(`qa-card-${n}`);if(!t)return;t.removeAttribute("aria-busy"),t.innerHTML="";const o=document.createElement("div");o.className="qa-type-badge",o.textContent=v(n),t.appendChild(o);const r=document.createElement("div");r.className="qa-section";const a=document.createElement("strong");a.textContent="ğŸ’¬ ì§ˆì˜";const c=document.createElement("div");c.className="qa-content",c.textContent=e.query,r.appendChild(a),r.appendChild(c),t.appendChild(r);const i=document.createElement("div");i.className="qa-section";const d=document.createElement("strong");d.textContent="âœ¨ ë‹µë³€";const l=document.createElement("div");l.className="qa-content",l.innerHTML=x(e.answer),i.appendChild(d),i.appendChild(l),t.appendChild(i);const g=document.createElement("div");g.className="btn-row qa-btn-row";const p=document.createElement("button");p.className="btn-small qa-copy-btn",p.textContent="ğŸ“‹ ë³µì‚¬",p.addEventListener("click",()=>E(e.query,e.answer)),g.appendChild(p),t.appendChild(g)}function P(n,e){const t=document.getElementById(`qa-card-${n}`);if(!t)return;t.removeAttribute("aria-busy"),t.innerHTML="",t.className="qa-card error-state",t.setAttribute("role","alert");const o=document.createElement("div");o.className="error-state__icon",o.textContent="âš ï¸",t.appendChild(o);const r=document.createElement("h3");r.style.cssText="margin: 0 0 8px 0; color: var(--accent-danger);",r.textContent=`${v(n)} ìƒì„± ì‹¤íŒ¨`,t.appendChild(r);const a=document.createElement("p");a.className="error-state__text",a.textContent=e,t.appendChild(a)}async function O(n){const e=document.getElementById("results");if(!e)return;const o=document.getElementById("ocr-input").value;if(!o.trim()){m("OCR í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.","error");return}e.innerHTML="",(n==="batch_three"?["global_explanation","reasoning","target_long"]:["global_explanation","reasoning","target_short","target_long"]).forEach(a=>e.appendChild(D(a)));try{const a=await fetch("/api/qa/generate/batch/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:n,ocr_text:o}),signal:u?.signal});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);if(!a.body)throw new Error("No response body");const c=a.body.getReader(),i=new TextDecoder;let d="";for(;;){const{done:l,value:g}=await c.read();if(l)break;d+=i.decode(g,{stream:!0});const p=d.split(`

`);d=p.pop()||"";for(const h of p){if(!h.startsWith("data: "))continue;const y=h.slice(6).trim();try{const s=JSON.parse(y);if(s.event!=="started"){if(s.event==="progress")R(s.type,s.data);else if(s.event==="error")s.type?P(s.type,s.error):m(`ì˜¤ë¥˜: ${s.error}`,"error");else if(s.event==="done"){const f=s.success?`âœ… ì™„ë£Œ: ${s.completed}/${s.total} ì„±ê³µ`:"âš ï¸ ì¼ë¶€ ì‹¤íŒ¨";m(f,s.success?"success":"warning")}}}catch(s){console.error("Failed to parse SSE event:",y,s)}}}}catch(a){console.error("Streaming error:",a);const c=a instanceof Error?a.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";e.innerHTML=`<div class="error-state"><div class="error-state__icon">âš ï¸</div><h3 style="margin: 0 0 8px 0; color: var(--accent-danger);">ìŠ¤íŠ¸ë¦¬ë° ì‹¤íŒ¨</h3><p class="error-state__text">${c}</p></div>`,m(`ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜: ${c}`,"error")}}function Q(){const n=Array.from(document.querySelectorAll('input[name="mode"]'));if(!n.length)return;const e=t=>{const o=n[t];o.focus(),o.checked=!0,o.dispatchEvent(new Event("change",{bubbles:!0}))};n.forEach((t,o)=>{t.addEventListener("keydown",r=>{let a=o;r.key==="ArrowRight"||r.key==="ArrowDown"?(a=(o+1)%n.length,r.preventDefault(),e(a)):r.key==="ArrowLeft"||r.key==="ArrowUp"?(a=(o-1+n.length)%n.length,r.preventDefault(),e(a)):r.key==="Home"?(r.preventDefault(),e(0)):r.key==="End"&&(r.preventDefault(),e(n.length-1))})})}function J(){k(),T(),document.getElementById("save-ocr-btn")?.addEventListener("click",()=>_()),document.querySelectorAll('input[name="mode"]').forEach(n=>{n.addEventListener("change",e=>{const t=document.getElementById("type-selector");t&&(t.style.display=e.target.value==="single"?"block":"none")})}),document.getElementById("generate-btn")?.addEventListener("click",async()=>{const e=document.querySelector('input[name="mode"]:checked')?.value||"single",t=document.getElementById("qtype"),o=e==="single"?t.value:null;e==="batch"||e==="batch_three"?await O(e):await H(e,o)}),Q(),document.addEventListener("keydown",n=>{n.key==="Escape"&&u&&(u.abort(),m("ìš”ì²­ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.","warning"))})}export{O as generateQAStreaming,J as initQA};
//# sourceMappingURL=qa.C_hzFDrO.js.map
