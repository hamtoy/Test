import{s as g,a as C,w as q,b as k}from"../app.js";import{l as T,s as _}from"./ocr.js";import{validateRequest as N,ValidationError as L}from"./validation.js";let p=null;function A(n){return n==="batch"?{title:"âš¡ 4ê°œ íƒ€ì… ë™ì‹œ ìƒì„± ì¤‘...",eta:"30ì´ˆ~2ë¶„"}:n==="batch_three"?{title:"âš¡ 3ê°œ íƒ€ì… ë™ì‹œ ìƒì„± ì¤‘...",eta:"20ì´ˆ~90ì´ˆ"}:{title:"ğŸš€ ë‹µë³€ ìƒì„± ì¤‘...",eta:"15ì´ˆ~1ë¶„"}}function S(n){const{title:e,eta:t}=A(n);return`
        <div class="progress-container" style="text-align: center; padding: 40px 20px; background: var(--bg-secondary, #f5f5f5); border-radius: 8px;">
            <h3 style="margin-bottom: 20px; color: var(--text-primary, #333);">${e}</h3>
            <div style="margin: 25px auto; width: 320px; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                <div class="progress-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary, #21808d) 0%, var(--primary-dark, #1a6673) 100%); transition: width 0.5s ease;"></div>
            </div>
            <p style="color: var(--text-secondary, #666); font-size: 0.95em; margin-top: 20px; font-weight: 500;">ì˜ˆìƒ ì†Œìš” ì‹œê°„: <strong>${t}</strong></p>
            <p style="color: var(--text-secondary, #666); font-size: 0.85em; margin-top: 8px;">ë³‘ë ¬ ì²˜ë¦¬ë¡œ ë¹ ë¥´ê²Œ ì™„ë£Œë©ë‹ˆë‹¤ âœ¨</p>
        </div>
    `}function $(n){const e=document.createElement("div");return e.textContent=n||"",e.innerHTML}function w(n){var o;const e=n||"",t=(o=window.marked)!=null&&o.parse?window.marked.parse(e,{breaks:!0}):$(e).replaceAll(`

`,"<br><br>").replaceAll(`
`,"<br>").replaceAll(" - ","<br><br>- ");return window.DOMPurify?window.DOMPurify.sanitize(t):t}function v(n){return{explanation:"ğŸŒ ì „ë°˜ ì„¤ëª…",global_explanation:"ğŸŒ ì „ë°˜ ì„¤ëª…",reasoning:"ğŸ§  ì¶”ë¡ ",target_short:"ğŸ¯ íƒ€ê²Ÿ ë‹¨ë‹µ",target_long:"ğŸ“ íƒ€ê²Ÿ ì¥ë‹µ"}[n]||n}function E(n,e){const t=`ğŸ’¬ ì§ˆì˜
${n}

âœ¨ ë‹µë³€
${e}`;navigator.clipboard.writeText(t).then(()=>{g("í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.","success")}).catch(()=>{g("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.","error")})}function I(n){if(!n||typeof n!="object")return!1;const e=n;return typeof e.type=="string"&&typeof e.query=="string"&&typeof e.answer=="string"}function M(n){var o,a;if(!n||typeof n!="object")return[];const e=n,t=[];return e.pairs&&t.push(...e.pairs),e.pair&&t.push(e.pair),(o=e.data)!=null&&o.pairs&&t.push(...e.data.pairs),(a=e.data)!=null&&a.pair&&t.push(e.data.pair),t.filter(I)}function B(n){var a;let e=M(n);const t=document.getElementById("results");if(!t)return;if(t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.innerHTML="",((a=document.querySelector('input[name="mode"]:checked'))==null?void 0:a.value)==="batch_three"){const r=new Set(["global_explanation","reasoning","target_long"]);e=e.filter(c=>r.has(c.type))}if(!e.length){const r=document.createElement("div");r.className="qa-card";const c=document.createElement("p");c.className="qa-empty-message",c.textContent="ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.",r.appendChild(c),t.appendChild(r);return}e.forEach((r,c)=>{const s=document.createElement("div");s.className="qa-card",s.style.animation=`slideIn 0.3s ease-out ${c*.05}s both`;const d=document.createElement("div");d.className="qa-header";const l=document.createElement("span");l.className="qa-type-badge",l.textContent=v(r.type),d.appendChild(l),s.appendChild(d);const u=document.createElement("div");u.className="qa-section";const m=document.createElement("strong");m.textContent="ğŸ’¬ ì§ˆì˜";const y=document.createElement("div");y.className="qa-content",y.textContent=r.query,u.appendChild(m),u.appendChild(y),s.appendChild(u);const h=document.createElement("div");h.className="qa-section";const i=document.createElement("strong");i.textContent="âœ¨ ë‹µë³€";const f=document.createElement("div");f.className="qa-content",f.innerHTML=w(r.answer),h.appendChild(i),h.appendChild(f),s.appendChild(h);const x=document.createElement("div");x.className="btn-row qa-btn-row";const b=document.createElement("button");b.className="btn-small qa-copy-btn",b.textContent="ğŸ“‹ ë³µì‚¬",b.addEventListener("click",()=>{E(r.query||"",r.answer||"")}),x.appendChild(b),s.appendChild(x),t.appendChild(s)})}async function H(n,e){const t=document.getElementById("results");if(!t)return;const a=document.getElementById("ocr-input").value;if(!a.trim()){g("OCR í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.","error");return}t.innerHTML=S(n);const r=C(n==="batch"||n==="batch_three"?"batch":"single"),c=document.querySelector(".progress-fill");try{const s=n==="single"?{mode:"single",ocr_text:a,qtype:e||"global_explanation"}:{mode:"batch",ocr_text:a};n==="batch_three"&&(s.batch_types=["global_explanation","reasoning","target_long"]);try{N(s,"/api/qa/generate")}catch(l){if(l instanceof L){g(`ìš”ì²­ ê²€ì¦ ì‹¤íŒ¨: ${l.message}`,"error"),r(),t.innerHTML=`
                    <div style="text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;">
                        <h3 style="color: #f44336; margin-bottom: 10px;">âš ï¸ ìš”ì²­ ë°ì´í„° ì˜¤ë¥˜</h3>
                        <p style="color: #666; margin: 0; white-space: pre-line;">${l.message}</p>
                        <p style="color: #999; margin-top: 15px; font-size: 0.9em;">ğŸ’¡ í•„ë“œëª…ê³¼ ë°ì´í„° íƒ€ì…ì„ í™•ì¸í•˜ì„¸ìš”</p>
                    </div>
                `;return}throw l}p&&p.abort(),p=new AbortController;const d=await q(()=>k("/api/qa/generate","POST",s,p.signal),2,800);p=null,r(),c&&(c.style.width="100%"),await new Promise(l=>setTimeout(l,300)),B(d)}catch(s){p=null,r();const d=s instanceof Error?s.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";t.innerHTML=`
            <div style="text-align: center; padding: 30px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336; margin-top: 20px;">
                <h3 style="color: #f44336; margin-bottom: 10px;">âŒ ìƒì„± ì‹¤íŒ¨</h3>
                <p style="color: #666; margin: 0;">${d}</p>
            </div>
        `}}function D(n){const e=document.createElement("div");e.className="qa-card",e.id=`qa-card-${n}`,e.setAttribute("aria-busy","true");const t=document.createElement("div");t.className="qa-type-badge",t.textContent=v(n),e.appendChild(t);const o=document.createElement("div");o.className="skeleton skeleton-text",o.style.cssText="height: 1.5em; width: 80%; margin: 16px 0",e.appendChild(o);const a=document.createElement("div");return a.className="skeleton skeleton-block",a.style.cssText="height: 100px; margin: 16px 0",e.appendChild(a),e}function R(n,e){const t=document.getElementById(`qa-card-${n}`);if(!t)return;t.removeAttribute("aria-busy"),t.innerHTML="";const o=document.createElement("div");o.className="qa-type-badge",o.textContent=v(n),t.appendChild(o);const a=document.createElement("div");a.className="qa-section";const r=document.createElement("strong");r.textContent="ğŸ’¬ ì§ˆì˜";const c=document.createElement("div");c.className="qa-content",c.textContent=e.query,a.appendChild(r),a.appendChild(c),t.appendChild(a);const s=document.createElement("div");s.className="qa-section";const d=document.createElement("strong");d.textContent="âœ¨ ë‹µë³€";const l=document.createElement("div");l.className="qa-content",l.innerHTML=w(e.answer),s.appendChild(d),s.appendChild(l),t.appendChild(s);const u=document.createElement("div");u.className="btn-row qa-btn-row";const m=document.createElement("button");m.className="btn-small qa-copy-btn",m.textContent="ğŸ“‹ ë³µì‚¬",m.addEventListener("click",()=>E(e.query,e.answer)),u.appendChild(m),t.appendChild(u)}function P(n,e){const t=document.getElementById(`qa-card-${n}`);if(!t)return;t.removeAttribute("aria-busy"),t.innerHTML="",t.className="qa-card error-state",t.setAttribute("role","alert");const o=document.createElement("div");o.className="error-state__icon",o.textContent="âš ï¸",t.appendChild(o);const a=document.createElement("h3");a.style.cssText="margin: 0 0 8px 0; color: var(--accent-danger);",a.textContent=`${v(n)} ìƒì„± ì‹¤íŒ¨`,t.appendChild(a);const r=document.createElement("p");r.className="error-state__text",r.textContent=e,t.appendChild(r)}async function O(n){const e=document.getElementById("results");if(!e)return;const o=document.getElementById("ocr-input").value;if(!o.trim()){g("OCR í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.","error");return}e.innerHTML="",(n==="batch_three"?["global_explanation","reasoning","target_long"]:["global_explanation","reasoning","target_short","target_long"]).forEach(r=>e.appendChild(D(r)));try{const r=await fetch("/api/qa/generate/batch/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:n,ocr_text:o}),signal:p==null?void 0:p.signal});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);if(!r.body)throw new Error("No response body");const c=r.body.getReader(),s=new TextDecoder;let d="";for(;;){const{done:l,value:u}=await c.read();if(l)break;d+=s.decode(u,{stream:!0});const m=d.split(`

`);d=m.pop()||"";for(const y of m){if(!y.startsWith("data: "))continue;const h=y.slice(6).trim();try{const i=JSON.parse(h);if(i.event!=="started"){if(i.event==="progress")R(i.type,i.data);else if(i.event==="error")i.type?P(i.type,i.error):g(`ì˜¤ë¥˜: ${i.error}`,"error");else if(i.event==="done"){const f=i.success?`âœ… ì™„ë£Œ: ${i.completed}/${i.total} ì„±ê³µ`:"âš ï¸ ì¼ë¶€ ì‹¤íŒ¨";g(f,i.success?"success":"warning")}}}catch(i){console.error("Failed to parse SSE event:",h,i)}}}}catch(r){console.error("Streaming error:",r);const c=r instanceof Error?r.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";e.innerHTML=`<div class="error-state"><div class="error-state__icon">âš ï¸</div><h3 style="margin: 0 0 8px 0; color: var(--accent-danger);">ìŠ¤íŠ¸ë¦¬ë° ì‹¤íŒ¨</h3><p class="error-state__text">${c}</p></div>`,g(`ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜: ${c}`,"error")}}function Q(){const n=Array.from(document.querySelectorAll('input[name="mode"]'));if(!n.length)return;const e=t=>{const o=n[t];o.focus(),o.checked=!0,o.dispatchEvent(new Event("change",{bubbles:!0}))};n.forEach((t,o)=>{t.addEventListener("keydown",a=>{let r=o;a.key==="ArrowRight"||a.key==="ArrowDown"?(r=(o+1)%n.length,a.preventDefault(),e(r)):a.key==="ArrowLeft"||a.key==="ArrowUp"?(r=(o-1+n.length)%n.length,a.preventDefault(),e(r)):a.key==="Home"?(a.preventDefault(),e(0)):a.key==="End"&&(a.preventDefault(),e(n.length-1))})})}function J(){var n,e;T(),(n=document.getElementById("save-ocr-btn"))==null||n.addEventListener("click",()=>_()),document.querySelectorAll('input[name="mode"]').forEach(t=>{t.addEventListener("change",o=>{const a=document.getElementById("type-selector");a&&(a.style.display=o.target.value==="single"?"block":"none")})}),(e=document.getElementById("generate-btn"))==null||e.addEventListener("click",async()=>{const t=document.querySelector('input[name="mode"]:checked'),o=(t==null?void 0:t.value)||"single",a=document.getElementById("qtype"),r=o==="single"?a.value:null;o==="batch"||o==="batch_three"?await O(o):await H(o,r)}),Q(),document.addEventListener("keydown",t=>{t.key==="Escape"&&p&&(p.abort(),g("ìš”ì²­ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.","warning"))})}export{O as generateQAStreaming,J as initQA};
//# sourceMappingURL=qa.js.map
